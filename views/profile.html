<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>أكاديمية المعالي | ملف الطالب</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

<style>
/* --- Styles Consistent with Index.html --- */
:root{
  --bg: #0b0b0c;
  --card-bg: #151517;
  --text-primary: #ffffff;
  --text-secondary: #a1a1aa;
  --border-color: rgba(255,255,255,0.08);
  --accent-color: #3b82f6; 
  --danger-color: #ef4444;
  --success-color: #43cf66;
  --warning-color: #f59e0b;
  --radius: 12px;
  --nav-height: 72px;
}

*{box-sizing:border-box;}

html,body{
  height:100%;
  margin:0;
  font-family: "Tajawal", sans-serif;
  background-color: var(--bg);
  background-image: 
    radial-gradient(circle at 15% 50%, rgba(255, 255, 255, 0.03) 0%, transparent 25%),
    radial-gradient(circle at 85% 50%, rgba(255, 255, 255, 0.03) 0%, transparent 25%);
  color: var(--text-primary);
  line-height:1.6;
}

/* --- Navbar (Glassmorphism) --- */
.navbar{
  height: var(--nav-height);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px; 
  margin: 15px; 
  border-radius: var(--radius);
  background: rgba(26, 26, 29, 0.85); 
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-color);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  position: sticky;
  top: 10px;
  z-index: 100;
}

.brand-group{
  display:flex; align-items:center; gap:10px;
}
.brand-group h1{ font-size: 18px; margin:0; font-weight:700; color: #fff;}
.back-btn{
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--border-color);
  color: var(--text-secondary);
  padding: 8px 15px;
  border-radius: 8px;
  text-decoration: none;
  font-size: 14px;
  transition: all 0.2s;
}
.back-btn:hover{ background: rgba(255,255,255,0.1); color: #fff; }

/* --- Container & Layout --- */
#container{
  max-width: 1000px;
  margin: 0 auto;
  padding: 0 15px 50px 15px;
}

.profile-header-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 25px;
    margin-bottom: 25px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 20px;
}

.profile-details h2 { margin: 0 0 10px 0; color: var(--accent-color); font-size: 24px; }
.profile-details p { margin: 5px 0; color: var(--text-secondary); font-size: 15px; }
.profile-details strong { color: #fff; }

.qr-section { text-align: center; }
.qr-section img { 
    width: 100px; height: 100px; 
    border: 4px solid #fff; border-radius: 8px; 
}
.qr-section button {
    display: block; margin-top: 10px; width: 100%;
    background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary);
    padding: 5px; border-radius: 6px; cursor: pointer; font-size: 12px; font-family: inherit;
}

/* --- Action Bar --- */
.action-bar {
    display: flex; gap: 10px; margin-bottom: 25px; justify-content: flex-end;
}
.btn-action {
    background: var(--accent-color); color: #fff; border: none;
    padding: 10px 20px; border-radius: 8px; font-weight: 600; font-family: inherit;
    cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;
}
.btn-action:hover { background: #2563eb; transform: translateY(-2px); }
.btn-secondary-action {
    background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary);
}
.btn-secondary-action:hover { background: rgba(255,255,255,0.05); }

/* --- Subject Cards --- */
.grid-container {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;
    margin-bottom: 30px;
}

.subject-card {
    background: var(--card-bg); border: 1px solid var(--border-color);
    border-radius: var(--radius); padding: 20px; position: relative;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
}

.subject-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
}
.subject-title { font-size: 18px; font-weight: 700; color: #fff; border-right: 3px solid var(--accent-color); padding-right: 10px;}

.add-session-btn {
    background: rgba(59, 130, 246, 0.1); color: var(--accent-color); border: 1px solid var(--accent-color);
    width: 28px; height: 28px; border-radius: 6px; cursor: pointer;
    display: flex; align-items: center; justify-content: center; font-size: 18px;
}
.add-session-btn:hover { background: var(--accent-color); color: #fff; }

.progress-info { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-secondary); margin-bottom: 5px; }

.progress-bar-bg {
    height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin-bottom: 20px;
}
.progress-bar-fill { height: 100%; transition: width 0.5s ease; background: var(--accent-color); }
.completed .progress-bar-fill { background: var(--success-color); }

/* Sessions Bubbles */
.sessions-list {
    display: flex; flex-wrap: wrap; gap: 8px; list-style: none; padding: 0; margin: 0;
}
.session-item {
    width: 35px; height: 35px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: bold; cursor: pointer;
    border: 1px solid var(--border-color); background: rgba(255,255,255,0.02);
    transition: all 0.2s; position: relative;
}
.session-item.completed { background: rgba(67, 207, 102, 0.2); color: var(--success-color); border-color: var(--success-color); }
.session-item.pending { color: var(--text-secondary); }
.session-item:hover { transform: scale(1.1); border-color: #fff; }

/* --- Attendance Table --- */
.table-section { background: var(--card-bg); border-radius: var(--radius); border: 1px solid var(--border-color); overflow: hidden; }
.table-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); font-size: 16px; font-weight: 700; color: var(--accent-color); }
.table-container { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 14px; text-align: right; }
th { background: rgba(255,255,255,0.03); color: var(--text-primary); padding: 12px 20px; font-weight: 600; white-space: nowrap; }
td { padding: 12px 20px; border-bottom: 1px solid var(--border-color); color: var(--text-secondary); white-space: nowrap; }
tr:last-child td { border-bottom: none; }

.badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
.badge-paid { background: rgba(67, 207, 102, 0.15); color: var(--success-color); }
.badge-unpaid { background: rgba(239, 68, 68, 0.15); color: var(--danger-color); }
.badge-checkin { background: rgba(59, 130, 246, 0.15); color: var(--accent-color); }

.delete-btn {
    background: transparent; border: 1px solid var(--danger-color); color: var(--danger-color);
    padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 11px;
}
.delete-btn:hover { background: var(--danger-color); color: #fff; }

/* --- MODALS (Glassy) --- */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
    z-index: 2000; display: none; align-items: center; justify-content: center;
}
.modal-content {
    background: rgba(21, 21, 23, 0.95); border: 1px solid rgba(255,255,255,0.1);
    border-radius: var(--radius); padding: 25px; width: 90%; max-width: 450px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5); text-align: right;
}
.modal-title { font-size: 18px; color: var(--accent-color); margin-bottom: 20px; font-weight: 700; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;}

.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 8px; color: #fff; font-size: 14px; }
.form-control {
    width: 100%; padding: 10px; background: rgba(255,255,255,0.05);
    border: 1px solid var(--border-color); border-radius: 8px; color: #fff;
    font-family: inherit;
}
.form-control:focus { outline: none; border-color: var(--accent-color); background: rgba(59, 130, 246, 0.1); }

.modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

/* Custom Checkbox for Payment */
.payment-toggle {
    display: flex; align-items: center; gap: 10px; margin: 20px 0;
    padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px;
}
.payment-toggle input { width: 18px; height: 18px; accent-color: var(--success-color); }

</style>
</head>
<body>

<nav class="navbar">
    <div class="brand-group">
        <a href="/" class="back-btn">العودة للرئيسية</a>
    </div>
    <div class="brand-group">
        <h1>ملف الطالب</h1>
    </div>
</nav>

<div id="container">
    <div id="loading" style="text-align: center; padding: 40px; color: var(--text-secondary);">جاري تحميل البيانات...</div>
    
    <div id="profileContent" style="display: none;">
        <div class="profile-header-card">
            <div class="profile-details">
                <h2 id="studentName"></h2>
                <p>المرحلة: <strong id="studentPhase"></strong></p>
                <p>السنة: <strong id="studentYear"></strong></p>
                <p>الشعبة: <strong id="studentStream"></strong></p>
            </div>
            <div class="qr-section">
                <img id="qrCodeImage" src="" alt="QR">
                <button onclick="window.print()">طباعة QR</button>
            </div>
        </div>

        <div class="action-bar">
            <button class="btn-action btn-secondary-action" onclick="openAddSubjectModal()">+ إضافة مادة جديدة</button>
        </div>

        <div id="subjectsGrid" class="grid-container">
            </div>

        <div class="table-section">
            <div class="table-header">سجل الأنشطة والمدفوعات</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>النشاط / المادة</th>
                            <th>التفاصيل</th>
                            <th>حالة الدفع</th>
                            <th>إجراء</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody">
                        </tbody>
                </table>
            </div>
            <p id="noRecordsMsg" style="text-align: center; padding: 20px; color: var(--text-secondary); display: none;">لا يوجد سجل أنشطة.</p>
        </div>
    </div>
</div>

<div id="confirmModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title" id="confirmTitle">تأكيد الإجراء</div>
        <p id="confirmMessage" style="color: var(--text-secondary); line-height: 1.6;"></p>
        
        <div id="paymentSection" class="payment-toggle" style="display: none;">
            <input type="checkbox" id="isPaidCheckbox" checked>
            <label for="isPaidCheckbox" style="color: #fff; cursor: pointer;">تم دفع ثمن هذه الحصة؟</label>
        </div>

        <div class="modal-actions">
            <button class="btn-action btn-secondary-action" onclick="closeConfirmModal()">إلغاء</button>
            <button class="btn-action" id="confirmBtnYes">تأكيد</button>
        </div>
    </div>
</div>

<div id="addSubjectModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">إضافة مادة جديدة</div>
        <div class="form-group">
            <label>اختر المادة:</label>
            <select id="newSubjectSelect" class="form-control"></select>
        </div>
        <div class="form-group">
            <label>عدد الحصص الكلي:</label>
            <input type="number" id="newSubjectCount" class="form-control" min="1" value="4">
        </div>
        <div class="modal-actions">
            <button class="btn-action btn-secondary-action" onclick="document.getElementById('addSubjectModal').style.display='none'">إلغاء</button>
            <button class="btn-action" onclick="submitNewSubject()">إضافة</button>
        </div>
    </div>
</div>

<div id="addSessionsModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">زيادة عدد الحصص</div>
        <p style="color: var(--text-secondary); margin-bottom: 15px;">إضافة حصص إضافية للمادة: <strong id="targetSubjectName" style="color: #fff;"></strong></p>
        <div class="form-group">
            <label>عدد الحصص للإضافة:</label>
            <input type="number" id="sessionsToAddInput" class="form-control" min="1" value="1">
        </div>
        <div class="modal-actions">
            <button class="btn-action btn-secondary-action" onclick="document.getElementById('addSessionsModal').style.display='none'">إلغاء</button>
            <button class="btn-action" onclick="submitAddSessions()">تأكيد الزيادة</button>
        </div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const studentId = urlParams.get('id');
    let currentStudent = null;
    let confirmCallback = null;

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
        if (!studentId) {
            alert('No Student ID');
            window.location.href = '/';
            return;
        }
        fetchData();
        fetchQr();
    });

    async function fetchData() {
        try {
            const res = await fetch(`/student-details/${studentId}`);
            if(!res.ok) throw new Error('Failed');
            const data = await res.json();
            currentStudent = data.student;
            renderProfile(data.student);
            renderSubjects(data.student.subjects || []);
            renderHistory(data.attendance);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('profileContent').style.display = 'block';
        } catch (e) {
            document.getElementById('loading').textContent = 'خطأ في تحميل البيانات';
        }
    }

    async function fetchQr() {
        const res = await fetch(`/qr-code/${studentId}`);
        const data = await res.json();
        document.getElementById('qrCodeImage').src = data.qrCodeUrl;
    }

    // --- Renders ---
    function renderProfile(student) {
        document.getElementById('studentName').textContent = student.name;
        document.getElementById('studentPhase').textContent = student.phase;
        document.getElementById('studentYear').textContent = student.year;
        document.getElementById('studentStream').textContent = student.stream;
    }

    function renderSubjects(subjects) {
        const grid = document.getElementById('subjectsGrid');
        grid.innerHTML = '';
        
        subjects.forEach(sub => {
            const progress = (sub.completedSessions / sub.totalSessions) * 100;
            const isFinished = sub.completedSessions >= sub.totalSessions;
            
            // Bubbles Logic
            let bubbles = '';
            for(let i=1; i<=sub.totalSessions; i++) {
                const isDone = i <= sub.completedSessions;
                const cls = isDone ? 'completed' : 'pending';
                // Click Handler
                bubbles += `<li class="session-item ${cls}" onclick="handleSessionClick('${sub.name}', ${i}, ${isDone}, ${sub.completedSessions})">${i}</li>`;
            }

            const card = document.createElement('div');
            card.className = `subject-card ${isFinished ? 'completed' : ''}`;
            card.innerHTML = `
                <div class="subject-header">
                    <div class="subject-title">${sub.name}</div>
                    <button class="add-session-btn" title="زيادة عدد الحصص" onclick="openAddSessionsModal('${sub.name}')">+</button>
                </div>
                <div class="progress-info">
                    <span>المكتملة: ${sub.completedSessions}</span>
                    <span>الإجمالي: ${sub.totalSessions}</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" style="width: ${progress}%"></div>
                </div>
                <ul class="sessions-list">
                    ${bubbles}
                </ul>
            `;
            grid.appendChild(card);
        });
    }

    function renderHistory(attendance) {
        const tbody = document.getElementById('attendanceTableBody');
        tbody.innerHTML = '';
        if(!attendance) {
            document.getElementById('noRecordsMsg').style.display = 'block';
            return;
        }
        document.getElementById('noRecordsMsg').style.display = 'none';

        const rows = Object.entries(attendance).map(([key, val]) => ({...val, id: key}))
                     .sort((a,b) => b.timestamp - a.timestamp);

        rows.forEach(rec => {
            const date = new Date(rec.timestamp).toLocaleDateString('ar-EG', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
            let type = rec.type === 'Session Registered' ? 'حصة' : (rec.action === 'Check-in' ? 'حضور QR' : 'شطب');
            let details = rec.action;
            
            // Payment Badge logic
            let paymentBadge = '<span class="badge">-</span>';
            if (rec.type === 'Session Registered') {
                paymentBadge = rec.isPaid 
                    ? '<span class="badge badge-paid">مدفوع</span>' 
                    : '<span class="badge badge-unpaid">غير مدفوع</span>';
            } else if (rec.action === 'Check-in') {
                paymentBadge = '<span class="badge badge-checkin">تسجيل دخول</span>';
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${date}</td>
                <td>${rec.subject || type}</td>
                <td>${details}</td>
                <td>${paymentBadge}</td>
                <td><button class="delete-btn" onclick="deleteRecord('${rec.id}')">حذف</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- Interaction Logic (Session Click) ---
    function handleSessionClick(subjectName, sessionNum, isCompleted, currentCount) {
        // Logic: Can only click next available session OR unclick the last completed one.
        if (!isCompleted && sessionNum === currentCount + 1) {
            // Register Next Session
            openConfirmModal(
                `تسجيل الحصة رقم ${sessionNum} للمادة <strong>${subjectName}</strong>؟`,
                true, // Show Payment Checkbox
                async (paid) => {
                    await sendRequest(`/record-session-attended/${studentId}`, { subjectName, isPaid: paid });
                }
            );
        } else if (isCompleted && sessionNum === currentCount) {
            // Undo Last Session
            openConfirmModal(
                `هل تريد شطب الحصة رقم ${sessionNum} للمادة <strong>${subjectName}</strong>؟`,
                false,
                async () => {
                    await sendRequest(`/undo-session-attended/${studentId}`, { subjectName });
                }
            );
        } else {
            alert('يجب تسجيل الحصص بالترتيب (التالية) أو شطب آخر حصة فقط.');
        }
    }

    // --- Add Subject Logic ---
    async function openAddSubjectModal() {
        const modal = document.getElementById('addSubjectModal');
        const select = document.getElementById('newSubjectSelect');
        select.innerHTML = '<option>جاري التحميل...</option>';
        modal.style.display = 'flex';

        // Load Courses
        const res = await fetch('/courses');
        const courses = await res.json();
        
        // Find streams for this student
        const { phase, year, stream } = currentStudent;
        let availableSubjects = [];
        
        try {
            if(courses[phase][year][stream]) {
                availableSubjects = courses[phase][year][stream];
            } else if (courses[phase][year]['عامة']) {
                availableSubjects = courses[phase][year]['عامة'];
            }
        } catch(e) { console.log('Mapping error', e); }

        select.innerHTML = '';
        if(availableSubjects.length === 0) {
            const op = document.createElement('option');
            op.text = 'لا توجد مواد متاحة';
            select.add(op);
            return;
        }

        // Filter out already taken subjects
        const taken = currentStudent.subjects ? currentStudent.subjects.map(s => s.name) : [];
        availableSubjects.forEach(sub => {
            if(!taken.includes(sub)) {
                const op = document.createElement('option');
                op.value = sub;
                op.text = sub;
                select.add(op);
            }
        });
        
        if(select.options.length === 0) {
            select.innerHTML = '<option>جميع المواد مضافة بالفعل</option>';
        }
    }

    async function submitNewSubject() {
        const name = document.getElementById('newSubjectSelect').value;
        const count = document.getElementById('newSubjectCount').value;
        if(!name || !count) return;

        await sendRequest(`/add-subject/${studentId}`, { subjectName: name, sessionCount: count });
        document.getElementById('addSubjectModal').style.display = 'none';
    }

    // --- Add Sessions Logic ---
    let targetSubForAdd = '';
    function openAddSessionsModal(subName) {
        targetSubForAdd = subName;
        document.getElementById('targetSubjectName').textContent = subName;
        document.getElementById('addSessionsModal').style.display = 'flex';
    }

    async function submitAddSessions() {
        const count = document.getElementById('sessionsToAddInput').value;
        await sendRequest(`/add-sessions/${studentId}`, { subjectName: targetSubForAdd, sessionsToAdd: count });
        document.getElementById('addSessionsModal').style.display = 'none';
    }

    // --- Generic Request ---
    async function sendRequest(url, body) {
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            if(res.ok) {
                fetchData(); // Reload
            } else {
                const err = await res.json();
                alert('خطأ: ' + err.message);
            }
        } catch(e) { alert('خطأ في الاتصال'); }
    }

    // --- Helpers ---
    function deleteRecord(id) {
        if(confirm('حذف هذا السجل نهائياً؟')) {
            fetch(`/attendance/${studentId}/${id}`, {method: 'DELETE'})
            .then(() => fetchData());
        }
    }

    function openConfirmModal(msg, showPayment, callback) {
        document.getElementById('confirmMessage').innerHTML = msg;
        document.getElementById('paymentSection').style.display = showPayment ? 'flex' : 'none';
        document.getElementById('confirmModal').style.display = 'flex';
        
        confirmCallback = callback;
    }

    document.getElementById('confirmBtnYes').onclick = () => {
        const isPaid = document.getElementById('isPaidCheckbox').checked;
        if(confirmCallback) confirmCallback(isPaid);
        closeConfirmModal();
    };

    function closeConfirmModal() {
        document.getElementById('confirmModal').style.display = 'none';
        confirmCallback = null;
        document.getElementById('isPaidCheckbox').checked = true; // reset
    }

</script>
</body>
</html>
