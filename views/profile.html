<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no">
<title>أكاديمية المعالي | ملف الطالب</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

<style>
/* --- Styles Consistent with Index.html --- */
:root{
  --bg: #0b0b0c;
  --card-bg: #1e1e24; /* نفس لون بطاقات الرئيسية */
  --text-primary: #ffffff;
  --text-secondary: #a1a1aa;
  --border-color: rgba(255,255,255,0.08);
  --accent-color: #3b82f6; 
  --danger-color: #ff6347;
  --success-color: #43cf66;
  --radius: 16px;
  --nav-height: 72px;
}

*{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}

html,body{
  height:100%;
  margin:0;
  font-family: "Tajawal", sans-serif;
  background-color: var(--bg);
  background-image: 
    radial-gradient(circle at 15% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 25%),
    radial-gradient(circle at 85% 30%, rgba(255, 99, 71, 0.03) 0%, transparent 25%);
  color: var(--text-primary);
  line-height:1.6;
}

/* --- Buttons Helper --- */
.btn-style { 
    padding: 8px 16px; border: none; border-radius: 12px; font-weight: 500; cursor: pointer;
    transition: all 0.2s; font-family: "Tajawal", sans-serif; display: inline-flex;
    align-items: center; justify-content: center; gap: 8px; font-size: 14px; text-decoration: none;
}
.btn-primary { background-color: var(--accent-color); color: #fff; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
.btn-primary:hover { background-color: #2563eb; transform: translateY(-1px); }
.btn-secondary { background-color: rgba(255,255,255,0.05); color: var(--text-secondary); border: 1px solid var(--border-color); }
.btn-secondary:hover { background-color: rgba(255,255,255,0.1); color: #fff; }
.btn-danger { background-color: rgba(255, 99, 71, 0.1); color: var(--danger-color); border: 1px solid rgba(255, 99, 71, 0.2); }
.btn-danger:hover { background-color: var(--danger-color); color: #fff; }

/* --- Navbar --- */
.navbar{
  height: var(--nav-height);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px; margin: 10px; border-radius: var(--radius);
  background: rgba(26, 26, 29, 0.85); backdrop-filter: blur(12px);
  border: 1px solid var(--border-color);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  position: sticky; top: 10px; z-index: 100;
}
.navbar h1 { font-size: 18px; font-weight: 700; margin: 0; }

/* --- Layout --- */
#container{ max-width: 1000px; margin: 0 auto; padding: 0 10px 50px 10px; }

/* --- Profile Header Card --- */
.profile-header-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 18px;
    padding: 25px;
    margin-top: 20px;
    margin-bottom: 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
.profile-header-card::before {
    content: ''; position: absolute; top: 0; right: 0; width: 6px; height: 100%;
    background: var(--accent-color);
}

.student-info-group { display: flex; align-items: center; gap: 20px; flex: 1; min-width: 280px; }

/* Updated avatar container: supports image + initials fallback */
.student-avatar-lg {
    width: 80px; height: 80px; border-radius: 20px;
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: #fff; display: flex; align-items: center; justify-content: center;
    font-weight: 800; font-size: 32px; flex-shrink: 0;
    box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    position: relative; overflow: hidden;
}
.student-avatar-lg img {
    width: 100%; height: 100%; object-fit: cover; display: block;
}
.avatar-letters {
    position: absolute; inset: 0; display:flex; align-items:center; justify-content:center;
    font-weight: 800; font-size: 32px; color: #fff;
}

/* profile text */
.profile-text h2 { margin: 0 0 5px 0; color: #fff; font-size: 22px; }
.meta-badges { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
.meta-badge {
    background: rgba(255,255,255,0.06); padding: 4px 10px; border-radius: 8px;
    font-size: 12px; color: var(--text-secondary); border: 1px solid rgba(255,255,255,0.05);
}

.qr-section { display: flex; flex-direction: column; align-items: center; gap: 10px; }
.qr-frame { 
    background: #fff; padding: 5px; border-radius: 12px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
.qr-frame img { display: block; width: 90px; height: 90px; }

/* --- Action Bar --- */
.action-bar { display: flex; justify-content: flex-end; margin-bottom: 20px; }

/* --- Subject Cards Grid --- */
.grid-container {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;
    margin-bottom: 30px;
}

.subject-card {
    background: var(--card-bg); border: 1px solid var(--border-color);
    border-radius: 18px; padding: 20px; position: relative;
    transition: transform 0.2s, box-shadow 0.2s;
}
.subject-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.3); border-color: rgba(59, 130, 246, 0.3); }

.subject-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
.subject-title { font-size: 17px; font-weight: 700; color: #fff; }
.subject-progress-text { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

.btn-add-session {
    width: 32px; height: 32px; border-radius: 10px; background: rgba(59, 130, 246, 0.1);
    color: var(--accent-color); border: 1px solid rgba(59, 130, 246, 0.2);
    display: flex; align-items: center; justify-content: center; cursor: pointer;
    transition: all 0.2s; font-size: 18px;
}
.btn-add-session:hover { background: var(--accent-color); color: #fff; }

/* Progress Bar */
.progress-container { height: 6px; background: rgba(255,255,255,0.08); border-radius: 10px; overflow: hidden; margin-bottom: 15px; }
.progress-fill { height: 100%; background: var(--success-color); border-radius: 10px; transition: width 0.5s ease; box-shadow: 0 0 10px rgba(67, 207, 102, 0.4); }

/* Bubbles */
.sessions-list { display: flex; flex-wrap: wrap; gap: 6px; padding: 0; margin: 0; list-style: none; }
.session-item {
    width: 32px; height: 32px; border-radius: 10px; /* Squircle */
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700; cursor: pointer;
    background: rgba(255,255,255,0.03); border: 1px solid var(--border-color);
    color: var(--text-secondary); transition: all 0.2s;
}
.session-item:hover { border-color: var(--accent-color); color: #fff; transform: scale(1.05); }
.session-item.completed { 
    background: var(--success-color); color: #000; border-color: var(--success-color);
    box-shadow: 0 2px 8px rgba(67, 207, 102, 0.3);
}

/* --- Table --- */
.table-section { background: var(--card-bg); border-radius: 18px; border: 1px solid var(--border-color); overflow: hidden; }
.table-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); font-size: 16px; font-weight: 700; color: #fff; background: rgba(255,255,255,0.02); }
.table-container { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 14px; text-align: right; }
th { padding: 12px 20px; color: var(--text-secondary); font-weight: 500; font-size: 12px; border-bottom: 1px solid var(--border-color); }
td { padding: 14px 20px; border-bottom: 1px solid rgba(255,255,255,0.03); color: #e4e4e7; }
tr:last-child td { border-bottom: none; }

.badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; }
.badge-paid { background: rgba(67, 207, 102, 0.15); color: #43cf66; border: 1px solid rgba(67, 207, 102, 0.2); }
.badge-unpaid { background: rgba(255, 99, 71, 0.15); color: #ff6347; border: 1px solid rgba(255, 99, 71, 0.2); }
.badge-checkin { background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.2); }

/* --- Modals --- */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
    z-index: 2000; display: none; align-items: center; justify-content: center;
}
.modal-content {
    background: #18181b; border: 1px solid rgba(255,255,255,0.1);
    border-radius: 18px; padding: 25px; width: 90%; max-width: 450px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: right;
}
.modal-title { font-size: 18px; color: #fff; margin-bottom: 20px; font-weight: 700; }
.form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 13px; }
.form-control {
    width: 100%; padding: 12px; background: rgba(255,255,255,0.05);
    border: 1px solid var(--border-color); border-radius: 12px; color: #fff;
    font-family: inherit; font-size: 14px;
}
.form-control:focus { outline: none; border-color: var(--accent-color); background: rgba(30, 30, 35, 1); }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }

/* Custom Checkbox */
.payment-toggle {
    display: flex; align-items: center; gap: 12px; margin: 20px 0;
    padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.2);
}
.payment-toggle input { width: 20px; height: 20px; accent-color: var(--accent-color); cursor: pointer;}
.payment-toggle label { margin: 0; color: #fff; font-weight: 500; cursor: pointer;}

</style>
</head>
<body>

<nav class="navbar">
    <div class="brand-group">
        <a href="/" class="btn-style btn-secondary">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            الرئيسية
        </a>
    </div>
    <h1>ملف الطالب</h1>
</nav>

<div id="container">
    <div id="loading" style="text-align: center; padding: 60px; color: var(--text-secondary);">
        <svg style="width:40px;height:40px;animation:spin 1s linear infinite;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
        <p style="margin-top:10px">جاري تحميل البيانات...</p>
    </div>
    
    <div id="profileContent" style="display: none;">
        
        <div class="profile-header-card">
            <div class="student-info-group">
                <!-- Avatar now supports image (with fallback to initials) -->
                <div class="student-avatar-lg" id="studentAvatar">
                    <img id="avatarImg" src="" alt="avatar" style="display:none;">
                    <div id="avatarLetters" class="avatar-letters"></div>
                </div>

                <div class="profile-text">
                    <h2 id="studentName"></h2>
                    <div class="meta-badges">
                        <span class="meta-badge" id="studentPhase"></span>
                        <span class="meta-badge" id="studentYear"></span>
                        <span class="meta-badge" id="studentStream"></span>
                    </div>
                </div>
            </div>
            <div class="qr-section">
                <div class="qr-frame">
                    <img id="qrCodeImage" src="" alt="QR">
                </div>
                <button class="btn-style btn-secondary" onclick="window.print()" style="font-size:12px; padding:6px 12px;">طباعة QR</button>
            </div>
        </div>

        <div class="action-bar">
            <button class="btn-style btn-primary" onclick="openAddSubjectModal()">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                إضافة مادة
            </button>
        </div>

        <div id="subjectsGrid" class="grid-container">
            </div>

        <div class="table-section">
            <div class="table-header">سجل الحضور والمدفوعات</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>النشاط</th>
                            <th>التفاصيل</th>
                            <th>حالة الدفع</th>
                            <th>إجراء</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody"></tbody>
                </table>
            </div>
            <p id="noRecordsMsg" style="text-align: center; padding: 30px; color: var(--text-secondary); display: none;">لا يوجد سجل نشاط حتى الآن.</p>
        </div>
    </div>
</div>

<div id="confirmModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title" id="confirmTitle">تأكيد الإجراء</div>
        <p id="confirmMessage" style="color: #d4d4d8; line-height: 1.6; margin-bottom: 10px;"></p>
        
        <div id="paymentSection" class="payment-toggle" style="display: none;">
            <input type="checkbox" id="isPaidCheckbox" checked>
            <label for="isPaidCheckbox">استلام المبلغ (مدفوع)؟</label>
        </div>

        <div class="modal-actions">
            <button class="btn-style btn-secondary" onclick="closeConfirmModal()">إلغاء</button>
            <button class="btn-style btn-primary" id="confirmBtnYes">تأكيد</button>
        </div>
    </div>
</div>

<div id="addSubjectModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">إضافة مادة جديدة</div>
        <div class="form-group">
            <label>اختر المادة:</label>
            <select id="newSubjectSelect" class="form-control"></select>
        </div>
        <div class="form-group">
            <label>عدد الحصص الكلي:</label>
            <input type="number" id="newSubjectCount" class="form-control" min="1" value="4">
        </div>
        <div class="modal-actions">
            <button class="btn-style btn-secondary" onclick="document.getElementById('addSubjectModal').style.display='none'">إلغاء</button>
            <button class="btn-style btn-primary" onclick="submitNewSubject()">إضافة</button>
        </div>
    </div>
</div>

<div id="addSessionsModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">تمديد الحصص</div>
        <p style="color: var(--text-secondary); margin-bottom: 20px; font-size:14px;">إضافة حصص جديدة للمادة: <strong id="targetSubjectName" style="color: #fff;"></strong></p>
        <div class="form-group">
            <label>عدد الحصص الإضافية:</label>
            <input type="number" id="sessionsToAddInput" class="form-control" min="1" value="4">
        </div>
        <div class="modal-actions">
            <button class="btn-style btn-secondary" onclick="document.getElementById('addSessionsModal').style.display='none'">إلغاء</button>
            <button class="btn-style btn-primary" onclick="submitAddSessions()">حفظ</button>
        </div>
    </div>
</div>

<style>
@keyframes spin { 100% { transform: rotate(360deg); } }
</style>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const studentId = urlParams.get('id');
    let currentStudent = null;
    let confirmCallback = null;

    // Default icon requested to be used
    const DEFAULT_ICON = 'https://res.cloudinary.com/duixjs8az/image/upload/v1766409915/post_media/1766409915005-student.png';

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
        if (!studentId) {
            window.location.href = '/';
            return;
        }
        fetchData();
        fetchQr();
    });

    async function fetchData() {
        try {
            const res = await fetch(`/student-details/${studentId}`);
            if(!res.ok) throw new Error('Failed');
            const data = await res.json();
            currentStudent = data.student;
            
            renderProfile(data.student);
            renderSubjects(data.student.subjects || []);
            renderHistory(data.attendance);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('profileContent').style.display = 'block';
        } catch (e) {
            document.getElementById('loading').innerHTML = '<p style="color:#ff6347">فشل تحميل البيانات. تأكد من الاتصال.</p>';
        }
    }

    async function fetchQr() {
        try {
            const res = await fetch(`/qr-code/${studentId}`);
            const data = await res.json();
            document.getElementById('qrCodeImage').src = data.qrCodeUrl;
        } catch(e){}
    }

    // --- Renders ---
    function renderProfile(student) {
        document.getElementById('studentName').textContent = student.name;
        document.getElementById('studentPhase').textContent = student.phase;
        document.getElementById('studentYear').textContent = student.year;
        
        let streamText = student.stream;
        if(student.stream === 'عامة') streamText = '';
        document.getElementById('studentStream').textContent = streamText;
        if(!streamText) document.getElementById('studentStream').style.display = 'none';

        // Avatar: set image if available, otherwise show initials.
        const avatarImg = document.getElementById('avatarImg');
        const avatarLetters = document.getElementById('avatarLetters');
        const initials = (student.name || '').split(' ').map(n=>n[0] || '').join('').substring(0,2) || 'ط';

        // prefer student-provided avatarUrl, otherwise use DEFAULT_ICON
        const src = student.avatarUrl || DEFAULT_ICON;
        avatarImg.style.display = 'none';
        avatarLetters.style.display = 'flex';
        avatarLetters.textContent = initials;

        // set image and handle load/error
        avatarImg.src = src;
        avatarImg.onload = () => {
            avatarImg.style.display = 'block';
            avatarLetters.style.display = 'none';
        };
        avatarImg.onerror = () => {
            avatarImg.style.display = 'none';
            avatarLetters.style.display = 'flex';
            avatarLetters.textContent = initials;
        };
    }

    function renderSubjects(subjects) {
        const grid = document.getElementById('subjectsGrid');
        grid.innerHTML = '';
        
        subjects.forEach(sub => {
            const progress = sub.totalSessions > 0 ? (sub.completedSessions / sub.totalSessions) * 100 : 0;
            const isFinished = sub.completedSessions >= sub.totalSessions;
            
            // Generate Bubbles
            let bubbles = '';
            for(let i=1; i<=sub.totalSessions; i++) {
                const isDone = i <= sub.completedSessions;
                const cls = isDone ? 'completed' : 'pending';
                bubbles += `<li class="session-item ${cls}" onclick="handleSessionClick('${sub.name}', ${i}, ${isDone}, ${sub.completedSessions})">${i}</li>`;
            }

            const card = document.createElement('div');
            card.className = `subject-card`;
            card.innerHTML = `
                <div class="subject-header">
                    <div>
                        <div class="subject-title">${sub.name}</div>
                        <div class="subject-progress-text">${sub.completedSessions} من ${sub.totalSessions} حصص مكتملة</div>
                    </div>
                    <button class="btn-add-session" title="زيادة الحصص" onclick="openAddSessionsModal('${sub.name}')">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                    </button>
                </div>
                
                <div class="progress-container">
                    <div class="progress-fill" style="width: ${Math.round(progress)}%"></div>
                </div>
                
                <ul class="sessions-list">
                    ${bubbles}
                </ul>
            `;
            grid.appendChild(card);
        });
    }

    function renderHistory(attendance) {
        const tbody = document.getElementById('attendanceTableBody');
        tbody.innerHTML = '';
        if(!attendance || Object.keys(attendance).length === 0) {
            document.getElementById('noRecordsMsg').style.display = 'block';
            return;
        }
        document.getElementById('noRecordsMsg').style.display = 'none';

        const rows = Object.entries(attendance).map(([key, val]) => ({...val, id: key}))
                     .sort((a,b) => b.timestamp - a.timestamp);

        rows.forEach(rec => {
            const date = new Date(rec.timestamp).toLocaleDateString('ar-EG', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
            let type = rec.type === 'Session Registered' ? 'حصة' : (rec.action === 'Check-in' ? 'تسجيل دخول' : 'تعديل');
            let details = rec.action; // Or clean text based on action
            if(rec.type === 'Session Registered') {
                details = `${rec.subject} (حصة ${rec.sessionNumber})`;
            }

            // Badges
            let badge = '<span class="badge">-</span>';
            if (rec.type === 'Session Registered') {
                badge = rec.isPaid 
                    ? '<span class="badge badge-paid">مدفوع</span>' 
                    : '<span class="badge badge-unpaid">غير مدفوع</span>';
            } else if (rec.action === 'Check-in') {
                badge = '<span class="badge badge-checkin">QR Scan</span>';
            } else if (rec.type === 'Session Undone') {
                badge = '<span class="badge badge-unpaid">شطب</span>';
                type = 'تراجع';
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${date}</td>
                <td>${type}</td>
                <td>${details}</td>
                <td>${badge}</td>
                <td><button class="btn-style btn-danger" style="padding:4px 8px; font-size:11px;" onclick="deleteRecord('${rec.id}')">حذف</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- Logic ---
    function handleSessionClick(subjectName, sessionNum, isCompleted, currentCount) {
        if (!isCompleted && sessionNum === currentCount + 1) {
            // Register Next
            openConfirmModal(
                `تسجيل الحصة رقم <strong>${sessionNum}</strong> لمادة ${subjectName}؟`,
                true,
                async (paid) => {
                    await sendRequest(`/record-session-attended/${studentId}`, { subjectName, isPaid: paid });
                }
            );
        } else if (isCompleted && sessionNum === currentCount) {
            // Undo Last
            openConfirmModal(
                `هل تريد إلغاء تسجيل الحصة رقم <strong>${sessionNum}</strong> لمادة ${subjectName}؟`,
                false,
                async () => {
                    await sendRequest(`/undo-session-attended/${studentId}`, { subjectName });
                }
            );
        }
    }

    async function openAddSubjectModal() {
        const modal = document.getElementById('addSubjectModal');
        const select = document.getElementById('newSubjectSelect');
        select.innerHTML = '<option>جاري التحميل...</option>';
        modal.style.display = 'flex';

        const res = await fetch('/courses');
        const courses = await res.json();
        const { phase, year, stream } = currentStudent;
        let list = [];
        
        try {
            if(courses[phase][year][stream]) list = courses[phase][year][stream];
            else if (courses[phase][year]['عامة']) list = courses[phase][year]['عامة'];
        } catch(e) {}

        select.innerHTML = '';
        const taken = currentStudent.subjects ? currentStudent.subjects.map(s => s.name) : [];
        let count = 0;
        
        list.forEach(sub => {
            if(!taken.includes(sub)) {
                const op = document.createElement('option');
                op.value = sub; op.text = sub;
                select.add(op);
                count++;
            }
        });
        
        if(count === 0) select.innerHTML = '<option disabled>جميع المواد مسجلة</option>';
    }

    async function submitNewSubject() {
        const name = document.getElementById('newSubjectSelect').value;
        const count = document.getElementById('newSubjectCount').value;
        if(!name || !count) return;
        await sendRequest(`/add-subject/${studentId}`, { subjectName: name, sessionCount: count });
        document.getElementById('addSubjectModal').style.display = 'none';
    }

    let targetSubForAdd = '';
    function openAddSessionsModal(subName) {
        targetSubForAdd = subName;
        document.getElementById('targetSubjectName').textContent = subName;
        document.getElementById('addSessionsModal').style.display = 'flex';
    }

    async function submitAddSessions() {
        const count = document.getElementById('sessionsToAddInput').value;
        await sendRequest(`/add-sessions/${studentId}`, { subjectName: targetSubForAdd, sessionsToAdd: count });
        document.getElementById('addSessionsModal').style.display = 'none';
    }

    async function sendRequest(url, body) {
        try {
            const res = await fetch(url, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            if(res.ok) fetchData();
            else {
                const err = await res.json().catch(()=>({message:'خطأ'}));
                alert(err.message || 'خطأ');
            }
        } catch(e) { alert('Network Error'); }
    }

    function deleteRecord(id) {
        if(confirm('حذف هذا السجل نهائياً؟')) {
            fetch(`/attendance/${studentId}/${id}`, {method: 'DELETE'}).then(() => fetchData());
        }
    }

    function openConfirmModal(msg, showPayment, callback) {
        document.getElementById('confirmMessage').innerHTML = msg;
        document.getElementById('paymentSection').style.display = showPayment ? 'flex' : 'none';
        document.getElementById('confirmModal').style.display = 'flex';
        confirmCallback = callback;
    }

    document.getElementById('confirmBtnYes').onclick = () => {
        const isPaid = document.getElementById('isPaidCheckbox').checked;
        if(confirmCallback) confirmCallback(isPaid);
        closeConfirmModal();
    };

    function closeConfirmModal() {
        document.getElementById('confirmModal').style.display = 'none';
        confirmCallback = null;
        document.getElementById('isPaidCheckbox').checked = true;
    }
</script>
</body>
</html>
