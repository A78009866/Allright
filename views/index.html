<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>أكاديمية المعالي - نظام إدارة الطلاب</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght300;400;500;700;800&display=swap" rel="stylesheet">

<style>
/* --- BASE STYLES --- */
:root{
  --bg: #0b0b0c;
  --drawer-bg: #151517;
  --text-primary: #ffffff;
  --text-secondary: #a1a1aa;
  --border-color: rgba(255,255,255,0.08);
  --accent-color: #3b82f6; 
  --nav-height: 72px;
  --radius: 12px;
}

*{box-sizing:border-box;}

html,body{
  height:100%;
  margin:0;
  font-family: "Tajawal", sans-serif;
  background-color: var(--bg);
  background-image: 
    radial-gradient(circle at 15% 50%, rgba(255, 255, 255, 0.03) 0%, transparent 25%),
    radial-gradient(circle at 85% 30%, rgba(255, 255, 255, 0.02) 0%, transparent 25%);
  color: var(--text-primary);
  -webkit-font-smoothing:antialiased;
  direction: rtl;
}

.page{
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
.navbar{
  height: var(--nav-height);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  margin: 16px;
  border-radius: var(--radius);
  background: rgba(26, 26, 29, 0.85); 
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-color);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  position: relative;
  z-index: 1000;
}
.brand{
  display:flex;
  align-items:center;
  gap:14px;
  flex-shrink: 0; 
  max-width: 80%;
}
.brand img{
  width:48px;
  height:48px;
  border-radius: 10px;
  object-fit: cover;
  border: 1px solid rgba(255,255,255,0.1);
}
.brand .title .name{
  font-weight: 800;
  font-size: 18px;
  color: #fff;
  line-height: 1.2;
}
.brand .title .tag{
  font-size: 13px;
  color: var(--text-secondary);
  font-weight: 400;
  margin-top: 2px;
}

.controls{
  display:flex;
  align-items:center;
  gap: 10px;
}

/* --- NEW GLASSY BUTTON STYLE (glassy-btn) --- */
.glassy-btn {
    background: rgba(161, 161, 170, 0.15); /* Gray/Glassy background */
    border: 1px solid rgba(161, 161, 170, 0.1);
    color: var(--text-secondary);
    padding: 8px 12px; /* Small padding */
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px; /* Small font size */
    font-weight: 500;
    transition: background 0.2s, color 0.2s, transform 0.1s;
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
    white-space: nowrap; /* لمنع كسر النص في الأزرار */
}
.glassy-btn:hover {
    background: rgba(161, 161, 170, 0.25);
    color: var(--text-primary);
}
.glassy-btn:active {
    transform: scale(0.98);
}
.glassy-btn:disabled {
    background: rgba(161, 161, 170, 0.05);
    cursor: not-allowed;
    color: rgba(161, 161, 170, 0.4);
}
/* Style for the icon-only button (QR Scanner) */
.icon-btn {
    padding: 8px; /* Square padding */
    width: 40px; 
    height: 40px;
    justify-content: center;
}
.icon-btn svg {
    width: 20px;
    height: 20px;
    margin: 0;
}


/* --- MAIN CONTENT & CARDS --- */
.content{
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
  width: 100%;
  flex-grow: 1;
}

.cards-grid{
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.student-card{
  background: var(--drawer-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  padding: 20px;
  transition: transform 0.2s, box-shadow 0.2s;
}
.student-card:hover{
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}
.student-card .name{
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--accent-color);
  margin-bottom: 8px;
}
.student-card .details{
  display:flex;
  justify-content: space-between;
  align-items: center;
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 12px;
  padding-bottom: 10px;
  border-bottom: 1px dashed var(--border-color);
}
.student-card .subjects{
  font-size: 14px;
  color: var(--text-primary);
  word-break: break-word;
}
.status-indicator{
  padding: 4px 8px;
  border-radius: 6px;
  font-weight: 600;
  font-size: 13px;
}
.status-active{
  background: rgba(67, 207, 102, 0.2);
  color: #43cf66;
}
.status-inactive{
  background: rgba(255, 99, 71, 0.2);
  color: #ff6347;
}

/* --- MODAL STYLES (Window) --- */
.modal {
  display: none; 
  position: fixed;
  z-index: 1001; 
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.7); 
  align-items: center;
  justify-content: center;
}

.modal-content {
  background-color: var(--bg);
  padding: 30px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  width: 90%;
  max-width: 600px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  position: relative;
}

.close-button {
  color: var(--text-secondary);
  float: left;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.close-button:hover,
.close-button:focus {
  color: #fff;
  text-decoration: none;
}

.modal-content h2 {
    color: var(--accent-color);
    margin-top: 0;
    border-bottom: 1px dashed var(--border-color);
    padding-bottom: 10px;
    margin-bottom: 20px;
}

/* --- FORM STYLES --- */
form label {
    display: block;
    margin-bottom: 5px;
    margin-top: 15px;
    font-weight: 500;
    color: var(--text-secondary);
}

form input[type="text"], 
form input[type="number"], 
form select {
    width: 100%;
    padding: 10px;
    margin-bottom: 5px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--drawer-bg);
    color: var(--text-primary);
    font-family: "Tajawal", sans-serif;
    font-size: 15px;
}

form select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath d='M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z' fill='%23a1a1aa'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 0.7em top 50%;
    background-size: 0.65em auto;
}

.submit-btn {
    background: var(--accent-color);
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 700;
    transition: background 0.2s;
    width: 100%;
}
.submit-btn:hover {
    background: #2563eb;
}
.submit-btn:disabled {
    background: #4b5563;
    cursor: not-allowed;
}

/* --- SUBJECT SELECTION STYLES (NEW) --- */
.add-subject-btn {
    background: #10b981; /* Teal */
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 10px;
    font-size: 15px;
    font-weight: 600;
    transition: background 0.2s;
    width: 100%;
}
.add-subject-btn:hover {
    background: #059669;
}
.selected-subjects-list {
    margin-top: 8px;
    padding: 10px;
    min-height: 50px;
    border: 1px dashed var(--border-color);
    border-radius: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-content: flex-start;
}
.subject-tag-item {
    background: rgba(59, 130, 246, 0.15); /* light blue */
    color: var(--accent-color);
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    line-height: 1;
}
.subject-tag-item .remove-btn {
    background: none;
    border: none;
    color: #ef4444; /* red */
    cursor: pointer;
    font-weight: bold;
    font-size: 16px;
    padding: 0;
    line-height: 1;
}
.subject-tag-item .remove-btn:hover {
    color: #dc2626;
}

/* --- QR SCANNER STYLES (NEW) --- */
#cameraFeed {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #000;
    z-index: 2000;
    display: none; 
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
#cameraFeed video {
    width: 100%;
    max-height: 80vh;
    object-fit: contain; 
}
#closeCamera {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    z-index: 2001;
}
#reader {
    width: 90%;
    max-width: 400px;
    margin: auto;
}
</style>
</head>
<body>

<div class="page">
    <header class="navbar">
        <div class="brand">
            <img src="https://res.cloudinary.com/duixjs8az/image/upload/v1765132270/post_media/1765132269901-1765132158292.jpg" alt="Logo">
            <div class="title">
                <div class="name">أكاديمية المعالي</div>
                <div class="tag">نظام إدارة الطلاب</div>
            </div>
        </div>

        <div class="controls">
            <button id="scanQrButton" class="glassy-btn icon-btn" title="مسح رمز QR لتسجيل الحضور">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="2" width="20" height="20" rx="2" ry="2"></rect>
                    <line x1="12" y1="3" x2="12" y2="21"></line>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                </svg>
            </button>
            <button id="openModalButton" class="glassy-btn">
                تسجيل طالب جديد
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle></svg>
            </button>
        </div>
    </header>

    <main class="content">
        <h1>الطلاب المسجلون</h1>
        <div class="cards-grid" id="studentCards">
            </div>
        <p id="loadingMessage" style="text-align: center; color: var(--text-secondary); margin-top: 50px;">جارٍ تحميل بيانات الطلاب...</p>
    </main>

    <footer>
        <p style="text-align: center; color: var(--text-secondary); font-size: 14px; padding: 20px;">
            © 2025 أكاديمية المعالي. جميع الحقوق محفوظة.
        </p>
    </footer>

</div>

<div id="studentModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>تسجيل طالب جديد</h2>
        <form id="addStudentForm">
            <label for="studentName">اسم الطالب:</label>
            <input type="text" id="studentName" required>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <div style="flex: 1;">
                    <label for="courseLevel">المرحلة التعليمية:</label>
                    <select id="courseLevel" required>
                        <option value="">اختر المرحلة</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <label for="courseStream">الشعبة/الجذع:</label>
                    <select id="courseStream" required>
                        <option value="">اختر الشعبة (اختياري)</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                 <div style="flex: 1;">
                    <label for="courseSubject">المادة:</label>
                    <select id="courseSubject" required>
                        <option value="">اختر المادة</option>
                    </select>
                </div>
                 <div style="width: 150px;">
                    <label for="sessionsCount">عدد الحصص (إجمالي):</label>
                    <input type="number" id="sessionsCount" value="10" min="1" required>
                </div>
            </div>
           
            <button type="button" id="addSubjectButton" class="add-subject-btn">
                أضف المادة إلى قائمة التسجيل
            </button>
            
            <div style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                <label>المواد التي سيتم تسجيل الطالب بها:</label>
                <div id="selectedSubjectsList" class="selected-subjects-list">
                    <p style="color: var(--text-secondary);">لم يتم اختيار أي مواد بعد.</p>
                </div>
                <input type="hidden" id="subjectsInput" required> 
            </div>

            <button type="submit" class="submit-btn" style="margin-top: 20px;">تسجيل الطالب</button>
        </form>
        
        <div id="qrResult" style="text-align: center; margin-top: 20px; display: none;">
            <p style="color: #43cf66; font-size: 18px; font-weight: 700;">تم التسجيل بنجاح!</p>
            <h3 id="qrStudentName" style="color: #fff; margin: 10px 0;"></h3>
            <p style="color: var(--text-secondary);">الرقم التعريفي: <span id="qrStudentId"></span></p>
            <img id="qrCodeImg" src="" alt="QR Code" style="width: 200px; height: 200px; padding: 10px; background: white; border-radius: 8px;">
            <p>يمكنك الآن العودة للقائمة أو طباعة الرمز.</p>
            <button onclick="window.location.reload()" class="glassy-btn" style="margin-top: 15px; background: rgba(59, 130, 246, 0.2); color: var(--accent-color);">إضافة طالب آخر</button>
        </div>
    </div>
</div>

<div id="cameraFeed" style="display: none;">
    <button id="closeCamera">إغلاق الكاميرا</button>
</div>


<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- تحديد العناصر ---
        const studentCardsContainer = document.getElementById('studentCards');
        const loadingMessage = document.getElementById('loadingMessage');
        const modal = document.getElementById('studentModal');
        const openModalButton = document.getElementById('openModalButton');
        const closeButton = document.querySelector('.close-button');
        const form = document.getElementById('addStudentForm');
        const qrResultDiv = document.getElementById('qrResult');
        
        // عناصر واجهة تسجيل المواد الجديدة
        const levelSelect = document.getElementById('courseLevel');
        const streamSelect = document.getElementById('courseStream');
        const subjectSelect = document.getElementById('courseSubject');
        const sessionsCountInput = document.getElementById('sessionsCount');
        const addSubjectButton = document.getElementById('addSubjectButton');
        const selectedSubjectsListDiv = document.getElementById('selectedSubjectsList');
        const subjectsHiddenInput = document.getElementById('subjectsInput'); 
        
        // عناصر مسح QR
        const scanQrButton = document.getElementById('scanQrButton');
        const cameraFeed = document.getElementById('cameraFeed');
        const closeCameraBtn = document.getElementById('closeCamera');
        
        let html5QrcodeScanner;
        let availableCourses = {}; 
        let selectedSubjects = []; 

        // --- وظائف الـ Modal ---

        openModalButton.onclick = async function() {
            // إعادة ضبط الـ Modal عند الفتح
            form.style.display = 'block';
            form.reset();
            qrResultDiv.style.display = 'none';
            selectedSubjects = [];
            renderSelectedSubjects();
            
            // جلب المواد عند فتح النافذة
            await fetchCourses(); 
            modal.style.display = 'flex';
        }
        
        closeButton.onclick = function() {
            modal.style.display = 'none';
        }
        
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        // --- منطق جلب وتحميل المواد ---
        async function fetchCourses() {
            try {
                const response = await fetch('/courses');
                availableCourses = await response.json();
                
                // 1. ملء قائمة المراحل
                levelSelect.innerHTML = '<option value="">اختر المرحلة</option>';
                Object.keys(availableCourses).forEach(level => {
                    const option = document.createElement('option');
                    option.value = level;
                    option.textContent = level;
                    levelSelect.appendChild(option);
                });
                
                // إعادة ضبط الشعب والمواد
                streamSelect.innerHTML = '<option value="">اختر الشعبة (اختياري)</option>';
                subjectSelect.innerHTML = '<option value="">اختر المادة</option>';
                
            } catch (error) {
                console.error('Error fetching courses:', error);
            }
        }

        // 2. تحديث قائمة الشعب/الأفرع بناءً على المرحلة المختارة
        levelSelect.addEventListener('change', () => {
            const selectedLevel = levelSelect.value;
            streamSelect.innerHTML = '<option value="">اختر الشعبة (اختياري)</option>';
            subjectSelect.innerHTML = '<option value="">اختر المادة</option>';
            
            if (selectedLevel && availableCourses[selectedLevel]) {
                const subjects = availableCourses[selectedLevel];
                // استخدام Set لجلب الشعب الفريدة
                const streams = [...new Set(subjects.map(sub => sub.stream).filter(s => s))]; 
                
                streams.forEach(stream => {
                    const option = document.createElement('option');
                    option.value = stream;
                    option.textContent = stream;
                    streamSelect.appendChild(option);
                });
            }
            // إطلاق تحديث المواد بعد تغيير المرحلة
            streamSelect.dispatchEvent(new Event('change'));
        });

        // 3. تحديث قائمة المواد بناءً على المرحلة والشعبة
        streamSelect.addEventListener('change', () => {
            const selectedLevel = levelSelect.value;
            const selectedStream = streamSelect.value;
            subjectSelect.innerHTML = '<option value="">اختر المادة</option>';
            
            if (selectedLevel && availableCourses[selectedLevel]) {
                const subjects = availableCourses[selectedLevel];
                
                const filteredSubjects = subjects.filter(sub => {
                    // تصفية المواد حسب الشعبة
                    return !selectedStream || sub.stream === selectedStream || sub.stream === '';
                });
                
                filteredSubjects.forEach(sub => {
                    const option = document.createElement('option');
                    // القيمة تخزن بيانات أساسية لسهولة الإضافة
                    option.value = JSON.stringify(sub); 
                    option.textContent = sub.subject + (sub.stream ? ` (${sub.stream})` : '');
                    subjectSelect.appendChild(option);
                });
            }
        });

        // --- منطق إدارة المواد المختارة ---
        
        function renderSelectedSubjects() {
            selectedSubjectsListDiv.innerHTML = '';
            
            if (selectedSubjects.length === 0) {
                 selectedSubjectsListDiv.innerHTML = '<p style="color: var(--text-secondary);">لم يتم اختيار أي مواد بعد.</p>';
                 subjectsHiddenInput.removeAttribute('value'); 
                 return;
            }
            
            subjectsHiddenInput.value = 'hasSubjects'; 
            
            selectedSubjects.forEach((sub, index) => {
                const tag = document.createElement('div');
                tag.className = 'subject-tag-item';
                
                const displayText = `${sub.subject} (${sub.level}${sub.stream ? ' - ' + sub.stream : ''}) - حصص: ${sub.sessionsCount}`;
                tag.innerHTML = `
                    <span>${displayText}</span>
                    <button type="button" class="remove-btn" data-index="${index}">
                        &times;
                    </button>
                `;
                
                // إضافة معالج الحذف
                tag.querySelector('.remove-btn').onclick = () => removeSubject(index);
                
                selectedSubjectsListDiv.appendChild(tag);
            });
        }
        
        function removeSubject(index) {
            selectedSubjects.splice(index, 1);
            renderSelectedSubjects();
        }
        
        addSubjectButton.onclick = function() {
            const selectedSubjectValue = subjectSelect.value;
            const sessionsCount = parseInt(sessionsCountInput.value);

            if (!selectedSubjectValue || sessionsCount <= 0) {
                alert('الرجاء اختيار مادة وإدخال عدد حصص صحيح.');
                return;
            }
            
            const subjectData = JSON.parse(selectedSubjectValue);
            
            // التحقق لتفادي إضافة نفس المادة/الشعبة مرتين
            const isDuplicate = selectedSubjects.some(sub => 
                sub.subject === subjectData.subject && sub.stream === subjectData.stream
            );
            
            if (isDuplicate) {
                alert('هذه المادة/الشعبة مضافة مسبقاً للطالب.');
                return;
            }
            
            const newSubject = {
                ...subjectData,
                sessionsCount: sessionsCount
            };
            
            selectedSubjects.push(newSubject);
            renderSelectedSubjects();
            
            // إعادة ضبط حقول الاختيار
            levelSelect.value = '';
            streamSelect.innerHTML = '<option value="">اختر الشعبة (اختياري)</option>';
            subjectSelect.innerHTML = '<option value="">اختر المادة</option>';
            sessionsCountInput.value = '10';
        }
        
        // --- منطق إرسال Form ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (selectedSubjects.length === 0) {
                alert('الرجاء اختيار مادة واحدة على الأقل قبل التسجيل.');
                return;
            }
            
            const name = document.getElementById('studentName').value;
            const submitButton = form.querySelector('.submit-btn');

            submitButton.disabled = true;
            submitButton.textContent = 'جارٍ التسجيل...';
            
            try {
                const response = await fetch('/add-student', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, selectedSubjects: selectedSubjects })
                });

                const result = await response.json();

                if (response.ok) {
                    // عرض QR
                    const qrCodeImg = document.getElementById('qrCodeImg');
                    qrCodeImg.src = result.qrCode;
                    
                    document.getElementById('qrStudentName').textContent = result.studentData.name;
                    document.getElementById('qrStudentId').textContent = result.id;
                    
                    // تحديث قائمة بطاقات الطلاب
                    fetchStudentCards(); 
                    
                    // إخفاء الـ Form وعرض الـ QR
                    form.style.display = 'none';
                    qrResultDiv.style.display = 'block';

                    submitButton.textContent = 'تم التسجيل بنجاح!';
                } else {
                    alert('فشل في التسجيل: ' + result.message);
                    submitButton.textContent = 'تسجيل الطالب';
                    submitButton.disabled = false;
                }

            } catch (error) {
                console.error('Error adding student:', error);
                alert('حدث خطأ أثناء الاتصال بالخادم.');
                submitButton.textContent = 'تسجيل الطالب';
                submitButton.disabled = false;
            }
        });

        // --- منطق جلب وعرض بطاقات الطلاب (محدث) ---
        async function fetchStudentCards() {
            try {
                const response = await fetch('/students');
                const students = await response.json();

                loadingMessage.style.display = 'none';
                studentCardsContainer.innerHTML = '';

                if (Object.keys(students).length === 0) {
                    studentCardsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">لم يتم تسجيل أي طالب بعد.</p>';
                    return;
                }
                
                for (const [id, student] of Object.entries(students)) {
                    const card = document.createElement('div');
                    card.className = 'student-card';
                    card.style.cursor = 'pointer'; 
                    card.addEventListener('click', () => {
                        window.location.href = `/profile.html?id=${id}`;
                    });

                    const statusClass = student.isActive ? 'status-active' : 'status-inactive';
                    const statusText = student.isActive ? 'نشط' : 'منتهي الصلاحية';
                    
                    // عرض المواد المختارة
                    const subjectNames = (student.subjects || []).map(s => {
                         let name = s.subject;
                         if (s.stream) name += ` (${s.stream})`;
                         name += ` [${s.sessionsCount || 0}]`; // إضافة عدد الحصص
                         return name;
                    }).join(' | ');

                    card.innerHTML = `
                        <div class="name">${student.name}</div>
                        <div class="details">
                            <span>ID: ${id.substring(0, 8)}...</span>
                            <span class="status-indicator ${statusClass}">${statusText}</span>
                        </div>
                        <div class="subjects"><strong>المواد:</strong> ${subjectNames || 'لا يوجد مواد'}</div>
                    `;
                    studentCardsContainer.appendChild(card);
                }
                
            } catch (error) {
                console.error('Error fetching student cards:', error);
                loadingMessage.textContent = 'فشل في تحميل بيانات الطلاب.';
            }
        }

        // --- منطق الكاميرا ومسح QR (جديد) ---
        scanQrButton.onclick = function() {
            cameraFeed.style.display = 'flex';
            startQrScanner();
        };

        closeCameraBtn.onclick = function() {
            cameraFeed.style.display = 'none';
            stopQrScanner();
        };

        function stopQrScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().catch(err => {
                    console.error("Error stopping QR scanner:", err);
                });
                html5QrcodeScanner = null;
                // إزالة العنصر بعد التوقف لضمان إعادة التهيئة الصحيحة
                const qrBox = document.getElementById("reader");
                if (qrBox) qrBox.remove();
            }
        }

        function startQrScanner() {
            // التحقق إذا كان العنصر موجوداً بالفعل لتجنب التكرار
            let readerDiv = document.getElementById('reader');
            if (!readerDiv) {
                readerDiv = document.createElement('div');
                readerDiv.id = 'reader';
                // إدراج العنصر قبل زر الإغلاق
                cameraFeed.insertBefore(readerDiv, closeCameraBtn);
            }

            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", 
                { fps: 10, qrbox: { width: 250, height: 250 } }, 
                /* verbose= */ false);

            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }

        async function onScanSuccess(decodedText, decodedResult) {
            // إيقاف الكاميرا بمجرد نجاح المسح
            stopQrScanner(); 
            cameraFeed.style.display = 'none';
            
            // معالجة البيانات الممسوحة (التي يجب أن تكون رابط أو ID الطالب)
            const studentIdMatch = decodedText.match(/\/student\/([^/]+)$/);
            const studentId = studentIdMatch ? studentIdMatch[1] : null;

            if (studentId) {
                // الانتقال مباشرة إلى صفحة البروفايل
                window.location.href = `/profile.html?id=${studentId}`;
            } else {
                alert(`تم مسح رمز QR بنجاح ولكن لا يمكن التعرف على ID الطالب منه. البيانات الممسوحة: ${decodedText}`);
            }
        }

        function onScanFailure(error) {
            // يتم استخدام هذا لتجنب إظهار أخطاء متكررة أثناء المسح المستمر
        }

        // جلب الطلاب عند تحميل الصفحة
        fetchStudentCards();
        
    });
</script>

</body>
</html>
