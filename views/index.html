<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no">
<title>أكاديمية المعالي</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

<style>
/* CSS styles */
:root{
  --bg: #0b0b0c;
  --drawer-bg: #151517;
  --card-bg: #1e1e24;
  --text-primary: #ffffff;
  --text-secondary: #a1a1aa;
  --border-color: rgba(255,255,255,0.08);
  --accent-color: #3b82f6; 
  --danger-color: #ff6347; 
  --success-color: #43cf66; 
  --nav-height: 72px;
  --bottom-nav-height: 75px;
  --radius: 16px;
}

*{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}

html,body{
  height:100%;
  margin:0;
  font-family: "Tajawal", sans-serif;
  background-color: var(--bg);
  background-image: 
    radial-gradient(circle at 15% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 25%),
    radial-gradient(circle at 85% 30%, rgba(255, 99, 71, 0.03) 0%, transparent 25%);
  color: var(--text-primary);
  max-width: 100vw; 
  overflow-x: hidden; 
  -webkit-font-smoothing:antialiased;
  direction: rtl;
  padding-bottom: var(--bottom-nav-height);
}

.page{
  min-height:100vh;
  display:flex;
  flex-direction:column;
  padding-bottom: 80px;
}

/* --- BUTTONS --- */
.btn-style { 
    padding: 10px 18px;
    border: none;
    border-radius: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
    font-family: "Tajawal", sans-serif;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary { background-color: var(--accent-color); color: var(--text-primary); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
.btn-primary:hover { background-color: #2563eb; transform: translateY(-1px); }
.btn-secondary { background-color: var(--drawer-bg); color: var(--text-secondary); border: 1px solid var(--border-color); }

/* --- TOP NAVBAR --- */
.navbar{
  height: var(--nav-height);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 15px; 
  margin: 10px; 
  border-radius: var(--radius);
  background: rgba(26, 26, 29, 0.85); 
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-color);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  position: relative;
  z-index: 1000;
}
.brand-group{ display:flex; align-items:center; gap:10px; flex-shrink: 0; }
.brand-group img{ width:40px; height:40px; border-radius: 10px; object-fit: cover; border: 1px solid rgba(255,255,255,0.1); }
.brand-group .title .name{ font-weight: 800; font-size: 16px; color: #fff; line-height: 1.2; }
.brand-group .title .tag{ font-size: 12px; color: var(--text-secondary); font-weight: 400; margin-top: 2px; }

.nav-buttons .btn-scan {
    background: rgba(255,255,255,0.05); 
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    padding: 8px 12px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    display: flex; align-items: center; gap: 6px; font-size: 13px;
}
.nav-buttons .btn-scan svg { width: 18px; height: 18px; fill: currentColor; }

/* --- SEARCH BAR --- */
.search-section { padding: 10px 15px; position: sticky; top: 5px; z-index: 900; }
.search-container { position: relative; max-width: 1200px; margin: 0 auto; }
.search-input-wrapper { position: relative; display: flex; align-items: center; }
.search-icon { position: absolute; right: 15px; color: var(--text-secondary); width: 20px; height: 20px; pointer-events: none; }
#searchInput {
    width: 100%; padding: 14px 45px 14px 15px; border-radius: 14px;
    border: 1px solid var(--border-color); background: rgba(30, 30, 36, 0.95);
    color: #fff; font-family: "Tajawal", sans-serif; font-size: 15px;
    backdrop-filter: blur(10px); box-shadow: 0 4px 20px rgba(0,0,0,0.2); transition: all 0.3s ease;
}
#searchInput:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); background: rgba(40, 40, 45, 0.98); }

/* --- TABS (replaces previous simple buttons) --- */
.level-tabs { display:flex; gap:8px; justify-content:center; margin-top:10px; }
.tab-btn {
  padding: 8px 14px;
  background: transparent;
  color: var(--text-secondary);
  border: none;
  border-bottom: 2px solid transparent;
  cursor: pointer;
  font-weight: 700;
  border-radius: 6px 6px 0 0;
  transition: color 0.15s, background 0.12s, transform 0.08s;
}
.tab-btn:hover { transform: translateY(-2px); color: #fff; }
.tab-btn.active {
  color: #fff; 
  background: linear-gradient(90deg, rgba(59,130,246,0.12), rgba(99,102,241,0.04));
  border-bottom-color: var(--accent-color);
  box-shadow: 0 6px 18px rgba(59,130,246,0.07);
}

/* --- STUDENT CARDS --- */
.student-cards-section { padding: 10px 16px 20px 16px; max-width: 1200px; margin: 0 auto; }
.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px; }
.section-header h2 { font-size: 1.2rem; color: var(--text-secondary); margin: 0; font-weight: 600; }
.count-badge { background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; font-size: 12px; color: #fff; }
.cards-container { display: grid; grid-template-columns: 1fr; gap: 12px; }

/* Updated card style: full-width, minimal, attractive */
.student-card {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border: 1px solid rgba(255,255,255,0.04);
  border-radius: 14px;
  padding: 12px 14px;
  display: flex;
  flex-direction: row;
  gap: 12px;
  align-items: center;
  cursor: pointer;
  position: relative;
  transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s;
  overflow: hidden;
}
.student-card:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(0,0,0,0.45); border-color: rgba(59,130,246,0.25); }

.student-avatar {
    width: 64px; height: 64px; border-radius: 12px; overflow: hidden; flex-shrink: 0;
    display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg, #3b82f6, #2563eb);
    box-shadow: 0 6px 18px rgba(59,130,246,0.18);
}
.student-avatar img { width:100%; height:100%; object-fit:cover; display:block; }

/* content area (right side for RTL) */
.student-info { flex: 1; display:flex; flex-direction:column; gap:6px; overflow:hidden; text-align:right; }
.student-name { font-weight: 800; font-size: 16px; color: #fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.student-meta { font-size: 12px; color: var(--text-secondary); display:flex; gap:8px; align-items:center; justify-content:flex-end; }
.phase-tag { background: rgba(255,255,255,0.04); padding: 4px 8px; border-radius: 999px; font-size: 12px; color:#fff; font-weight:700; }

/* right-most area: progress + quick action */
.card-side {
  width: 130px; display:flex; flex-direction:column; align-items:center; gap:8px; justify-content:center;
}
.status-badge-small { font-size: 11px; padding: 6px 10px; border-radius: 999px; font-weight:700; }
.st-active { background: rgba(67, 207, 102, 0.12); color: #43cf66; border: 1px solid rgba(67, 207, 102, 0.18); }
.st-inactive { background: rgba(255, 99, 71, 0.12); color: #ff6347; border: 1px solid rgba(255, 99, 71, 0.14); }

.progress-wrapper { width:100%; display:flex; align-items:center; gap:8px; }
.progress-bar-bg { flex:1; height:6px; background: rgba(255,255,255,0.06); border-radius: 999px; overflow:hidden; }
.progress-bar-fill { height:100%; background: linear-gradient(90deg,#3b82f6,#60a5fa); border-radius:999px; }

.action-menu { position: absolute; top: 10px; left: 10px; z-index: 10; }
.action-menu-toggle { color: var(--text-secondary); background: transparent; border: none; font-size: 18px; cursor: pointer; padding: 5px; border-radius: 50%; transition: background 0.2s; }
.action-menu-toggle:hover { background: rgba(255,255,255,0.06); color: #fff; }
.action-menu-dropdown { position: absolute; left: 0; top: 35px; background-color: var(--drawer-bg); border: 1px solid var(--border-color); border-radius: var(--radius); box-shadow: 0 4px 15px rgba(0,0,0,0.5); min-width: 150px; display: none; z-index: 20; }
.action-menu-dropdown.active { display: block; }
.action-menu-dropdown button { width: 100%; padding: 10px 15px; text-align: right; background: none; border: none; color: var(--text-primary); cursor: pointer; }
.action-menu-dropdown button:hover { background-color: rgba(255, 255, 255, 0.04); }
.delete-action { color: var(--danger-color); }

/* --- BOTTOM NAV --- */
.bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--bottom-nav-height); background: rgba(21, 21, 23, 0.95); backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: flex-end; padding-bottom: 12px; z-index: 2000; padding-left: 20px; padding-right: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.4); }
.nav-item { background: none; border: none; display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--text-secondary); cursor: pointer; width: 60px; padding-bottom: 5px; }
.nav-item svg { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; }
.nav-item span { font-size: 11px; font-weight: 500; }
.nav-item.active { color: var(--accent-color); }
.nav-item.active svg { stroke: var(--accent-color); }
.fab-container { position: relative; top: -25px; display: flex; justify-content: center; align-items: center; }
.fab-btn { width: 60px; height: 60px; border-radius: 50%; background: var(--accent-color); border: 4px solid var(--bg); color: #fff; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.5); cursor: pointer; transition: transform 0.2s; }
.fab-btn:hover { transform: scale(1.05); }
.fab-btn svg { width: 28px; height: 28px; stroke: currentColor; stroke-width: 2.5; fill: none; }

/* --- MODAL --- */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 3000; display: none; align-items: center; justify-content: center; padding-bottom: 50px; }
.modal-overlay.open { display:flex; }
.modal-content { background: rgba(21, 21, 23, 0.95); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius); padding: 20px; width: 95%; max-width: 500px; max-height: 85vh; overflow-y: auto; text-align: right; backdrop-filter: blur(15px); }
.modal-close-btn { position: absolute; top: 10px; left: 10px; background: none; border: none; color: var(--text-secondary); font-size: 2rem; cursor: pointer; }
.modal-content h3 { margin-top: 0; font-size: 18px; color: var(--accent-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
.modal-content label { display: block; margin-bottom: 6px; font-weight: 500; color: #e4e4e7; font-size: 14px; }
.modal-content input[type="text"], .modal-content select, .subject-selection-area input[type="number"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 8px; background: rgba(255, 255, 255, 0.05); color: var(--text-primary); }
.name-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.subject-selection-area { margin-top: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: var(--radius); background: rgba(255, 255, 255, 0.02); }
.subject-checkboxes { display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; }
.subject-item-wrapper { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(255, 255, 255, 0.04); border-radius: 8px; }
.subject-item-wrapper input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
.subject-item-wrapper .session-count-input { width: 90px; padding: 6px; text-align: center; margin-bottom: 0 !important; background: #000; color: var(--accent-color); }

/* --- PRINTABLE STUDENT CARD STYLES --- */
.printable-card-container {
    background: #fff;
    color: #000;
    width: 320px;
    margin: 10px auto;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #ddd;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    font-family: "Tajawal", sans-serif;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.printable-card-container::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; height: 6px;
    background: linear-gradient(90deg, #3b82f6, #2563eb);
}

.pc-header {
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 10px;
    margin-bottom: 15px;
    justify-content: center;
}

.pc-logo { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
.pc-title h4 { margin: 0; font-size: 16px; color: #111; font-weight: 800; }
.pc-title span { font-size: 11px; color: #666; }

.pc-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.pc-student-name {
    font-size: 20px;
    font-weight: 800;
    color: #1a1a1d;
    margin: 5px 0;
}

.pc-info-row {
    font-size: 13px;
    color: #444;
    background: #f8f9fa;
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 500;
    border: 1px solid #eee;
}

.pc-qr-box {
    margin: 15px 0;
    padding: 10px;
    border: 2px dashed #ddd;
    border-radius: 10px;
    background: #fff;
}

.pc-qr-box img {
    width: 140px;
    height: 140px;
    display: block;
}

.pc-footer {
    font-size: 10px;
    color: #888;
    margin-top: 10px;
    border-top: 1px solid #f0f0f0;
    padding-top: 8px;
    width: 100%;
}

/* QR & Alert Styles */
.qr-scanner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; }
.qr-scanner-overlay.active { display: flex; }
#reader { width: 90%; max-width: 400px; border: 3px solid var(--accent-color); border-radius: var(--radius); overflow: hidden; }
#custom-alert-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; justify-content:center; align-items:center; }
#custom-alert-box { background:rgba(21, 21, 23, 0.95); padding:25px; border-radius:var(--radius); width:350px; border:1px solid var(--border-color); text-align:center; }

/* Responsive adjustments */
@media (max-width: 640px) {
  .card-side { width: 110px; }
  .student-avatar { width:56px; height:56px; }
  .student-card { padding:10px; gap:10px; }
}
</style>
</head>
<body>

<div class="page">
  <header class="navbar">
    <div class="brand-group">
      <img src="https://res.cloudinary.com/duixjs8az/image/upload/v1765132270/post_media/1765132269901-1765132158292.jpg" alt="Logo">
      <div class="title">
        <div class="name">أكاديمية المعالي</div>
        <div class="tag">للتعليم والتطوير</div>
      </div>
    </div>
    <div class="nav-buttons">
      <button class="btn-style btn-scan" id="scanBtn">
        <svg viewBox="0 0 24 24"><path d="M4 4h7v7H4zM13 4h7v7h-7zM4 13h7v7H4zM17 13h-2v2h2v-2zm0 4h-2v2h2v-2zm-4-4v2h-2v-2h2z"/></svg>
        مسح QR
      </button>
    </div>
  </header>

  <div class="search-section">
      <div class="search-container">
          <div class="search-input-wrapper">
            <input type="text" id="searchInput" placeholder="بحث عن طالب أو مادة دراسية...">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </div>

          <!-- Tabs that filter students by level -->
          <div class="level-tabs" id="levelTabs" role="tablist" aria-label="مستويات الطلاب">
            <button role="tab" aria-selected="true" class="tab-btn active" data-level="all">الكل</button>
            <button role="tab" class="tab-btn" data-level="ابتدائي">ابتدائي</button>
            <button role="tab" class="tab-btn" data-level="متوسط">متوسط</button>
            <button role="tab" class="tab-btn" data-level="ثانوي">ثانوي</button>
          </div>
      </div>
  </div>

  <div class="student-cards-section" id="homeSection">
      <div class="section-header">
        <h2>قائمة الطلاب</h2>
        <span class="count-badge" id="studentCountBadge">0</span>
      </div>
      
      <div class="cards-container" id="studentCardsContainer">
          <p id="loadingMessage" style="text-align: center; color: var(--text-secondary); margin-top:20px;">جارٍ تحميل البيانات...</p>
      </div>
  </div>
  
  <nav class="bottom-nav">
      <button class="nav-item active" id="btnHome" onclick="switchTab('home')">
          <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
          <span>الرئيسية</span>
      </button>

      <div class="fab-container">
          <button class="fab-btn" id="openRegisterModalBtn">
              <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
          </button>
      </div>

      <button class="nav-item" id="btnStats" onclick="switchTab('stats')">
          <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
          <span>البيانات</span>
      </button>
  </nav>

  <div class="modal-overlay" id="registrationModal">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="closeRegistrationModal()">&times;</button>
      
      <div id="registrationForm">
        <h3>تسجيل طالب جديد</h3>
        <div class="name-fields">
            <div><label for="studentName">الاسم:</label><input type="text" id="studentName" required></div>
            <div><label for="studentLastName">اللقب:</label><input type="text" id="studentLastName" required></div>
        </div>
        <label for="phaseSelect">المرحلة الدراسية:</label><select id="phaseSelect" required><option value="" disabled selected>اختر المرحلة</option></select>
        <label for="yearSelect">السنة الدراسية:</label><select id="yearSelect" required disabled><option value="" disabled selected>اختر السنة</option></select>
        <label for="streamSelect">الشعبة (التخصص):</label><select id="streamSelect" required disabled><option value="" disabled selected>اختر الشعبة</option></select>
        <div class="subject-selection-area">
          <label style="display:block; margin-bottom:10px; color:var(--accent-color);">تحديد المواد الدراسية:</label>
          <div class="subject-selection-header" style="display:flex; justify-content:space-between; margin-bottom:5px; color:#888; font-size:12px;"><span>اسم المادة</span><span>عدد الحصص</span></div>
          <div id="subjectCheckboxes" class="subject-checkboxes"><div style="text-align:center; padding:20px; color:var(--text-secondary);">الرجاء اختيار المرحلة أولاً.</div></div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top: 15px;">
            <button id="registerButton" class="btn-style btn-primary">تسجيل الطالب</button>
        </div>
      </div>

      <div class="modal-result" id="modalResult" style="display:none; text-align: center;">
        <h3 style="color: var(--success-color); border-bottom:none;">تم تسجيل الطالب بنجاح!</h3>
        
        <div class="printable-card-container" id="printableCard">
            <div class="pc-header">
                <img src="https://res.cloudinary.com/duixjs8az/image/upload/v1765132270/post_media/1765132269901-1765132158292.jpg" alt="Logo" class="pc-logo">
                <div class="pc-title">
                    <h4>أكاديمية المعالي</h4>
                    <span>للتعليم والتطوير</span>
                </div>
            </div>
            
            <div class="pc-body">
                <div class="pc-student-name" id="cardStudentName">اسم الطالب هنا</div>
                <div class="pc-info-row">
                    <span id="cardPhase">الطور</span> - <span id="cardYear">السنة</span>
                </div>
                <div class="pc-info-row" id="cardStreamRow">
                    <span id="cardStream">الشعبة</span>
                </div>
                
                <div class="pc-qr-box">
                    <img id="qrCodeImage" src="" alt="QR Code">
                </div>
            </div>
            
            <div class="pc-footer">
                بطاقة طالب مدرسية • يرجى إظهار هذه البطاقة عند الدخول
            </div>
        </div>

        <div style="display:flex; justify-content:center; gap:10px; margin-top: 20px;">
            <button class="btn-style btn-secondary" onclick="closeRegistrationModal()">إغلاق</button>
            <button class="btn-style btn-primary" onclick="downloadCardImage(this)">
                <svg viewBox="0 0 24 24" style="width:18px; height:18px; margin-left:5px; fill:none; stroke:currentColor; stroke-width:2;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                حفظ البطاقة
            </button>
        </div>
      </div>

    </div>
  </div>

  <div class="qr-scanner-overlay" id="qrScannerOverlay">
    <p class="scan-message" style="color:#fff; margin-bottom:15px;">امسح رمز QR الخاص بالطالب</p>
    <div id="reader"></div> 
    <button class="btn-style" style="background: var(--danger-color); color: white; margin-top:15px;" onclick="stopScannerAndClose()">إلغاء</button>
  </div>

</div>

<div id="custom-alert-overlay">
    <div id="custom-alert-box">
        <h3 id="custom-alert-title" style="margin-top:0; color:var(--text-primary);">تنبيه</h3>
        <p id="custom-alert-message" style="color:var(--text-secondary); margin-bottom:20px;"></p>
        <div id="custom-alert-actions" style="display:flex; justify-content:center; gap:10px;">
            <button id="custom-alert-ok" class="btn-style btn-primary" style="width:100px;">حسناً</button>
            <button id="custom-alert-cancel" class="btn-style btn-secondary" style="width:100px; display:none;">إلغاء</button>
        </div>
    </div>
</div>

<script>
  // --- DOM Elements ---
  const studentCardsContainer = document.getElementById('studentCardsContainer');
  const loadingMessage = document.getElementById('loadingMessage');
  const searchInput = document.getElementById('searchInput'); 
  const studentCountBadge = document.getElementById('studentCountBadge');
  
  // Registration Vars
  const openRegisterModalBtn = document.getElementById('openRegisterModalBtn');
  const registrationModal = document.getElementById('registrationModal');
  const scanBtn = document.getElementById('scanBtn'); 
  const qrScannerOverlay = document.getElementById('qrScannerOverlay'); 
  const phaseSelect = document.getElementById('phaseSelect');
  const yearSelect = document.getElementById('yearSelect');
  const streamSelect = document.getElementById('streamSelect');
  const subjectCheckboxes = document.getElementById('subjectCheckboxes');
  const registerButton = document.getElementById('registerButton');
  const registrationForm = document.getElementById('registrationForm');
  const modalResult = document.getElementById('modalResult');
  const qrCodeImage = document.getElementById('qrCodeImage');
  const levelTabs = document.getElementById('levelTabs');

  // Card Fields
  const cardStudentName = document.getElementById('cardStudentName');
  const cardPhase = document.getElementById('cardPhase');
  const cardYear = document.getElementById('cardYear');
  const cardStream = document.getElementById('cardStream');
  const cardStreamRow = document.getElementById('cardStreamRow');

  let COURSES_DATA = {}; 
  let html5QrCode = null; 
  let currentLevelFilter = 'all';

  // default avatar/icon supplied by user
  const DEFAULT_ICON = 'https://res.cloudinary.com/duixjs8az/image/upload/v1766404501/post_media/1766404500962-44bd283ec63956d10ff8fbe4859ba3b6.jpg';

  // --- Search Functionality ---
  searchInput.addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const cards = document.querySelectorAll('.student-card');
      cards.forEach(card => {
          const name = (card.dataset.name || '').toLowerCase();
          const subjects = (card.dataset.subjects || '').toLowerCase();
          const matchesText = name.includes(term) || subjects.includes(term);
          const matchesLevel = (currentLevelFilter === 'all') || ((card.dataset.level || '').toLowerCase() === currentLevelFilter.toLowerCase());
          card.style.display = (matchesText && matchesLevel) ? 'flex' : 'none';
      });
      updateVisibleCount();
  });

  // --- Tabs (level) Functionality ---
  levelTabs.addEventListener('click', (e) => {
      const btn = e.target.closest('.tab-btn');
      if(!btn) return;
      // visually mark active
      levelTabs.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
      btn.classList.add('active');
      btn.setAttribute('aria-selected','true');

      currentLevelFilter = btn.dataset.level || 'all';
      applyLevelFilter();
  });

  // support keyboard navigation for tabs (Arrow keys)
  levelTabs.addEventListener('keydown', (e) => {
      const focusable = Array.from(levelTabs.querySelectorAll('.tab-btn'));
      const idx = focusable.indexOf(document.activeElement);
      if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
          e.preventDefault();
          const prev = focusable[(idx - 1 + focusable.length) % focusable.length];
          prev.focus();
      } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
          e.preventDefault();
          const next = focusable[(idx + 1) % focusable.length];
          next.focus();
      } else if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          document.activeElement.click();
      }
  });

  function applyLevelFilter() {
      const cards = document.querySelectorAll('.student-card');
      const term = searchInput.value.toLowerCase();
      cards.forEach(card => {
          const matchesLevel = (currentLevelFilter === 'all') || ((card.dataset.level || '').toLowerCase() === currentLevelFilter.toLowerCase());
          const name = (card.dataset.name || '').toLowerCase();
          const subjects = (card.dataset.subjects || '').toLowerCase();
          const matchesText = name.includes(term) || subjects.includes(term);
          card.style.display = (matchesLevel && matchesText) ? 'flex' : 'none';
      });
      updateVisibleCount();
  }

  function updateVisibleCount() {
      const cards = document.querySelectorAll('.student-card');
      let visible = 0;
      cards.forEach(c => { if(c.style.display !== 'none') visible++; });
      studentCountBadge.textContent = visible;
  }

  // --- Tab Switching --- (bottom nav)
  function switchTab(tabName) {
    if (tabName === 'stats') window.location.href = '/stats.html';
  }

  // --- Alert System ---
  function showCustomConfirm(message, callback, title = 'تأكيد') {
      const overlay = document.getElementById('custom-alert-overlay');
      const msg = document.getElementById('custom-alert-message');
      const alertTitle = document.getElementById('custom-alert-title');
      const okBtn = document.getElementById('custom-alert-ok');
      const cancelBtn = document.getElementById('custom-alert-cancel');
      
      alertTitle.textContent = title;
      msg.innerHTML = message;
      cancelBtn.style.display = 'inline-flex';
      okBtn.textContent = 'تأكيد الحذف';
      okBtn.className = 'btn-style btn-primary delete-action'; 
      overlay.style.display = 'flex';
      
      okBtn.onclick = () => { overlay.style.display = 'none'; callback(true); };
      cancelBtn.onclick = () => { overlay.style.display = 'none'; callback(false); };
  }

  function showCustomAlert(message, title = 'تنبيه') {
      const overlay = document.getElementById('custom-alert-overlay');
      const msg = document.getElementById('custom-alert-message');
      const alertTitle = document.getElementById('custom-alert-title');
      const okBtn = document.getElementById('custom-alert-ok');
      const cancelBtn = document.getElementById('custom-alert-cancel');
      
      alertTitle.textContent = title;
      msg.innerHTML = message;
      cancelBtn.style.display = 'none';
      okBtn.textContent = 'حسناً';
      okBtn.className = 'btn-style btn-primary';
      overlay.style.display = 'flex';
      okBtn.onclick = () => { overlay.style.display = 'none'; };
  }

  document.addEventListener('click', (e) => {
      if (!e.target.closest('.action-menu')) {
          document.querySelectorAll('.action-menu-dropdown.active').forEach(d => d.classList.remove('active'));
      }
  });

  // --- QR Scanner ---
  async function onScanSuccess(decodedText) {
    await stopScannerAndClose(); 
    const studentId = decodedText.trim(); 
    if (studentId) window.location.href = `/profile.html?id=${studentId}`;
    else showCustomAlert('كود غير صالح', 'خطأ');
  }

  async function startScanner() {
    qrScannerOverlay.classList.add('active');
    if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
    try { await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess); }
    catch (err) { showCustomAlert('تأكد من إذن الكاميرا وHTTPS'); stopScannerAndClose(); }
  }

  async function stopScannerAndClose() {
    qrScannerOverlay.classList.remove('active');
    if (html5QrCode && html5QrCode.isScanning) await html5QrCode.stop();
  }
  scanBtn.addEventListener('click', startScanner);

  // --- Modal Logic ---
  openRegisterModalBtn.addEventListener('click', () => { openRegistrationModal(); populatePhases(); });
  function openRegistrationModal() { registrationModal.classList.add('open'); registrationForm.style.display = 'block'; modalResult.style.display = 'none'; }
  function closeRegistrationModal() { registrationModal.classList.remove('open'); document.getElementById('studentName').value = ''; document.getElementById('studentLastName').value = ''; phaseSelect.value = ''; yearSelect.disabled = true; streamSelect.disabled = true; subjectCheckboxes.innerHTML = 'الرجاء اختيار المرحلة...'; }
  
  // --- Form Population (Phases/Years/Streams) ---
  function populatePhases() {
    phaseSelect.innerHTML = '<option value="" disabled selected>اختر المرحلة</option>';
    for (const phase in COURSES_DATA) { const opt = document.createElement('option'); opt.value = phase; opt.textContent = phase; phaseSelect.appendChild(opt); }
  }
  phaseSelect.addEventListener('change', () => {
      yearSelect.innerHTML = '<option value="" disabled selected>اختر السنة</option>';
      if (phaseSelect.value) { for (const y in COURSES_DATA[phaseSelect.value]) { const opt = document.createElement('option'); opt.value = y; opt.textContent = y; yearSelect.appendChild(opt); } yearSelect.disabled = false; }
  });
  yearSelect.addEventListener('change', () => {
      streamSelect.innerHTML = '<option value="" disabled selected>اختر الشعبة</option>';
      const streams = COURSES_DATA[phaseSelect.value][yearSelect.value];
      const sNames = Object.keys(streams);
      if (sNames.length > 1 || (sNames.length === 1 && sNames[0] !== 'عامة')) {
          sNames.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.textContent = s; streamSelect.appendChild(opt); });
          streamSelect.disabled = false;
      } else { streamSelect.value = 'عامة'; populateSubjects(streams['عامة']); streamSelect.disabled = true; }
  });
  streamSelect.addEventListener('change', () => { populateSubjects(COURSES_DATA[phaseSelect.value][yearSelect.value][streamSelect.value]); });

  function populateSubjects(subs) {
      subjectCheckboxes.innerHTML = '';
      subs.forEach(sub => {
          const div = document.createElement('div'); div.className = 'subject-item-wrapper';
          const uid = `sub-${sub.replace(/\s/g,'-')}`;
          div.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="${uid}" value="${sub}" name="subj">
                <label for="${uid}" style="margin:0; cursor:pointer; color:#fff;">${sub}</label>
            </div>
            <input type="number" min="1" value="1" disabled class="session-count-input" id="c-${uid}">
          `;
          div.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
              const inp = document.getElementById(`c-${uid}`); inp.disabled = !e.target.checked;
              if(e.target.checked) inp.focus();
          });
          subjectCheckboxes.appendChild(div);
      });
  }

  // --- Register Action ---
  registerButton.addEventListener('click', async () => {
      const name = document.getElementById('studentName').value.trim();
      const last = document.getElementById('studentLastName').value.trim();
      const phase = phaseSelect.value;
      const year = yearSelect.value;
      const stream = streamSelect.disabled ? 'عامة' : streamSelect.value;
      
      const subs = Array.from(document.querySelectorAll('input[name="subj"]:checked')).map(cb => ({
          name: cb.value, sessionCount: document.getElementById(`c-${cb.id}`).value
      }));

      if (!name || !last || !phase || !year || subs.length === 0) return showCustomAlert('أكمل البيانات');
      
      const registerBtnOriginalText = registerButton.textContent;
      registerButton.textContent = 'جارٍ الحفظ...';
      registerButton.disabled = true;

      try {
          const res = await fetch('/register', {
              method: 'POST', headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ name, lastName: last, phase, year, stream, subjects: subs })
          });
          const data = await res.json();
          if (res.ok) {
              // Populate Card
              cardStudentName.textContent = `${name} ${last}`;
              cardPhase.textContent = phase;
              cardYear.textContent = year;
              if (stream !== 'عامة') {
                  cardStream.textContent = stream;
                  cardStreamRow.style.display = 'block';
              } else {
                  cardStreamRow.style.display = 'none';
              }
              qrCodeImage.src = data.qrCodeUrl;
              
              // Switch Views
              registrationForm.style.display = 'none'; 
              modalResult.style.display = 'block';
              
              fetchStudentCards();
          } else { throw new Error(data.message); }
      } catch (e) {
          showCustomAlert('خطأ: ' + e.message);
      } finally {
        registerButton.textContent = registerBtnOriginalText;
        registerButton.disabled = false;
      }
  });

  // --- Download Card as Image ---
  function downloadCardImage(btnElement) {
      const element = document.getElementById('printableCard');
      const originalContent = btnElement.innerHTML;

      btnElement.innerHTML = 'جارٍ الحفظ...';
      btnElement.disabled = true;

      html2canvas(element, {
          scale: 3, 
          useCORS: true, 
          backgroundColor: "#ffffff",
          allowTaint: true
      }).then(canvas => {
          const link = document.createElement('a');
          const studentName = document.getElementById('cardStudentName').innerText;
          link.download = `بطاقة-${studentName}.png`;
          link.href = canvas.toDataURL("image/png");
          link.click();

          btnElement.innerHTML = originalContent;
          btnElement.disabled = false;
      }).catch(err => {
          showCustomAlert("فشل حفظ البطاقة");
          btnElement.innerHTML = originalContent;
          btnElement.disabled = false;
      });
  }

  // --- Delete Student ---
  async function deleteStudent(id, name) {
      try {
          const res = await fetch(`/student/${id}`, { method: 'DELETE' });
          if(res.ok) { showCustomAlert(`تم حذف ${name}`); fetchStudentCards(); }
      } catch(e) { showCustomAlert('فشل الحذف'); }
  }

  // --- Generate Student Cards ---
  async function fetchStudentCards() {
      loadingMessage.style.display = 'block'; studentCardsContainer.innerHTML = '';
      try {
          const res = await fetch('/students');
          const data = await res.json();
          loadingMessage.style.display = 'none';
          
          const students = Object.values(data).sort((a,b) => b.registeredAt - a.registeredAt);
          // Show total (before filtering)
          studentCountBadge.textContent = students.length;

          if (students.length === 0) {
              studentCardsContainer.innerHTML = '<p style="text-align:center; color:#777; width:100%;">لا يوجد طلاب مسجلين.</p>';
              return;
          }

          students.forEach(std => {
              const card = document.createElement('div');
              card.className = 'student-card';
              
              // Prefer common fields for level; try different keys
              const level = std.phase || std.level || std.stage || (std.year && mapYearToLevel(std.year)) || '';
              const nameFull = std.name || `${std.firstName || ''} ${std.lastName || ''}`.trim() || 'طالب';

              const subjectNames = std.subjects ? std.subjects.map(s => s.name).join(' ') : '';
              
              card.dataset.name = nameFull;
              card.dataset.subjects = subjectNames;
              card.dataset.level = level;

              const totalReq = std.subjects ? std.subjects.reduce((a,b)=>a+parseInt(b.totalSessions || b.sessionCount || 0 || 0),0) : 0;
              const totalDone = std.subjects ? std.subjects.reduce((a,b)=>a+parseInt(b.completedSessions || 0),0) : 0;
              const isActive = totalReq === 0 ? false : (totalDone < totalReq);
              const statusClass = isActive ? 'st-active' : 'st-inactive';
              const statusText = isActive ? 'نشط' : 'منتهي';
              
              let subjectsHtml = '';
              if(std.subjects && std.subjects.length > 0) {
                  subjectsHtml = `<span style="font-size:12px; color:var(--text-secondary);">${std.subjects.slice(0,2).map(s => s.name).join('، ')}</span>`;
              } else { subjectsHtml = '<span style="font-size:12px; color:var(--text-secondary);">لا توجد مواد</span>'; }

              const progressPercent = totalReq > 0 ? (totalDone / totalReq) * 100 : 0;

              card.innerHTML = `
                  <div class="action-menu">
                      <button class="action-menu-toggle">⋮</button>
                      <div class="action-menu-dropdown">
                          <button class="delete-action" onclick="confirmDelete('${std.id}', '${nameFull}')">حذف الطالب</button>
                      </div>
                  </div>
                  
                  <div class="student-avatar">
                      <img src="${std.avatarUrl || DEFAULT_ICON}" alt="avatar">
                  </div>

                  <div class="student-info">
                      <div class="student-name">${nameFull}</div>
                      <div class="student-meta">
                          <span class="phase-tag">${level || (std.year || '')}</span>
                          ${std.stream && std.stream !== 'عامة' ? `<span>• ${std.stream}</span>` : ''}
                      </div>
                      <div style="display:flex; justify-content:flex-end; gap:10px; align-items:center;">
                          ${subjectsHtml}
                      </div>
                  </div>

                  <div class="card-side">
                      <div class="status-badge-small ${statusClass}">${statusText}</div>
                      <div class="progress-wrapper" style="width:100%;">
                          <div class="progress-bar-bg">
                              <div class="progress-bar-fill" style="width: ${Math.round(progressPercent)}%"></div>
                          </div>
                      </div>
                      <div style="font-size:12px; color:var(--text-secondary);">${Math.round(progressPercent)}%</div>
                  </div>
              `;

              card.addEventListener('click', (e) => {
                  if(!e.target.closest('.action-menu') && !e.target.closest('.delete-action')) {
                      window.location.href = `/profile.html?id=${std.id}`;
                  }
              });

              const toggle = card.querySelector('.action-menu-toggle');
              const menu = card.querySelector('.action-menu-dropdown');
              toggle.addEventListener('click', (e) => {
                  e.stopPropagation();
                  document.querySelectorAll('.action-menu-dropdown').forEach(m => { if(m!==menu) m.classList.remove('active'); });
                  menu.classList.toggle('active');
              });

              studentCardsContainer.appendChild(card);
          });

          // ensure default tab is 'الكل'
          const defaultTab = levelTabs.querySelector('[data-level="all"]');
          if (defaultTab) {
            levelTabs.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            defaultTab.classList.add('active');
            defaultTab.setAttribute('aria-selected','true');
            currentLevelFilter = 'all';
          }
          applyLevelFilter();

      } catch (e) { console.error(e); loadingMessage.style.display = 'none'; }
  }

  // attempt to map ambiguous year values to levels (simple heuristic)
  function mapYearToLevel(year) {
    if (!year) return '';
    const y = String(year);
    // very simple rules — adjust as needed for your data
    if (y.includes('ابتد')) return 'ابتدائي';
    if (y.includes('متوس') || y.match(/[4-6]|متوسط/)) return 'متوسط';
    if (y.includes('ثان') || y.match(/[7-12]|ثانوي/)) return 'ثانوي';
    return '';
  }

  window.confirmDelete = function(id, name) {
      showCustomConfirm(`حذف ${name}؟`, (yes) => { if(yes) deleteStudent(id, name); });
  }

  async function init() {
      try {
          const res = await fetch('/courses');
          COURSES_DATA = await res.json();
          fetchStudentCards();
      } catch (e) { fetchStudentCards(); }
  }
  init();

</script>
</body>
</html>
