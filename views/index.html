<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أكاديمية المعالي - دروس الدعم</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    @import url('https://fonts.googleapis.com/css2?family=Changa:wght@300;400;700&display=swap');

    <style>
        /* المتغيرات الأساسية - تصميم أسود زجاجي خالص */
        :root {
            --primary-accent: #cccccc; /* لون رمادي فاتح للتأكيد */
            --glass-button-color: rgba(255, 255, 255, 0.2); 
            --pure-black: #000000; 
            --glass-bg-color: rgba(0, 0, 0, 0.8); 
            --glass-card-bg: rgba(255, 255, 255, 0.05); 
            --glass-border-color: rgba(255, 255, 255, 0.1); 
            --text-light: #f0f0f0;
            --input-bg: rgba(255, 255, 255, 0.1);
            --input-border: rgba(255, 255, 255, 0.3);
            --hover-bg: rgba(255, 255, 255, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Changa', sans-serif;
            background-color: var(--pure-black);
            color: var(--text-light);
            min-height: 100vh;
        }

        /* شريط التنقل (Navbar) */
        .navbar {
            width: 100%;
            background: var(--glass-bg-color); 
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--glass-border-color);
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between; 
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            height: 40px;
            width: 40px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.3); 
        }

        .brand-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-light);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        .register-button {
            padding: 0.4rem 1.25rem; 
            background-color: var(--glass-button-color); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3); 
            color: var(--text-light); 
            font-weight: 500;
            text-decoration: none;
            border-radius: 50px; 
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); 
            cursor: pointer;
            font-family: 'Changa', sans-serif;
            font-size: 0.95rem; 
        }

        .register-button:hover {
            background-color: rgba(255, 255, 255, 0.35); 
            border-color: var(--primary-accent); 
            transform: scale(1.05); 
        }

        .main-content {
            padding: 30px 5%;
            background-color: var(--pure-black);
            min-height: calc(100vh - 64px); 
        }
        
        .section-title {
            text-align: center;
            color: var(--primary-accent);
            margin-bottom: 30px;
            font-size: 2.2rem;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
        }

        /* --- أنماط الأكورديون (البطاقات القابلة للطي) --- */
        .accordion-container {
            max-width: 800px;
            margin: auto;
        }
        
        .accordion-item {
            margin-bottom: 15px;
            background: var(--glass-card-bg); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .accordion-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary-accent);
            transition: background-color 0.3s;
        }
        
        .accordion-header:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .accordion-header .fas {
            transition: transform 0.3s ease;
        }
        
        .accordion-item.open .accordion-header .fa-chevron-down {
            transform: rotate(180deg);
            color: var(--text-light);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            padding: 0 20px;
        }
        
        .accordion-item.open .accordion-content {
            padding: 10px 20px 20px 20px;
            border-top: 1px solid var(--glass-border-color);
        }

        .stages-list {
            list-style: none;
            padding: 0;
        }

        .stage-item {
            padding: 12px 10px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            color: var(--text-light);
            border: 1px solid transparent;
        }

        .stage-item:hover, .stage-item.selected {
            background-color: var(--hover-bg);
            border-color: var(--primary-accent);
        }
        
        /* قسم اختيار المواد */
        #subjects-selection {
            background: var(--glass-card-bg); 
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border-color);
            border-radius: 15px;
            padding: 25px;
            margin: 40px auto;
            max-width: 700px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            display: none; 
            text-align: center;
        }
        
        #subjects-selection h4 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary-accent);
        }

        .subjects-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }

        .subject-button {
            padding: 10px 20px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 100px;
        }

        .subject-button:hover, .subject-button.selected {
            background-color: var(--primary-accent);
            color: var(--pure-black);
            transform: scale(1.05);
            box-shadow: 0 0 8px var(--primary-accent);
        }

        /* --- أنماط النافذة المنبثقة (Modal) --- */
        .modal {
            display: none; 
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9); 
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--glass-bg-color); 
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border-color);
            border-radius: 15px;
            margin: 10% auto; 
            padding: 30px;
            max-width: 450px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.7);
            position: relative;
        }

        .close-button {
            color: var(--primary-accent);
            float: left;
            font-size: 28px;
            font-weight: bold;
            transition: color 0.3s;
        }

        .close-button:hover,
        .close-button:focus {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--text-light); font-weight: 400; }
        .form-group input {
            width: 100%;
            padding: 10px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-light);
            border-radius: 8px;
            font-family: 'Changa', sans-serif;
            font-size: 1rem;
        }
        
        .form-info {
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--primary-accent);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 400;
        }

        .submit-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-accent);
            color: var(--pure-black);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Changa', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            transition: background-color 0.3s, transform 0.3s;
        }
        
        .submit-btn:hover {
            background-color: #f5f5f5;
            transform: scale(1.02);
        }

        /* تنسيق كود البار (للعرض في شاشة المتابعة) */
        #simulated-barcode-final {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 80px;
            width: 100%;
            max-width: 300px;
            margin: 10px auto 0;
        }
        .bar {
            width: 3px;
            background-color: white;
            margin: 0 1px;
        }
        
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo-container">
            <img src="https://res.cloudinary.com/duixjs8az/image/upload/v1765132270/post_media/1765132269901-1765132158292.jpg" 
                 alt="شعار أكاديمية المعالي" 
                 class="logo">
            
            <span class="brand-name">أكاديمية المعالي</span>
        </div>
        
        <div>
            <a href="/admin" class="register-button">لوحة الأدمن</a>
        </div>
    </nav>

    <main class="main-content">
        
        <section id="support-courses">
            <h2 class="section-title"><i class="fas fa-chalkboard-teacher"></i> دروس الدعم المتوفرة</h2>
            <div class="accordion-container">
                
                <div class="accordion-item" data-level="ابتدائي">
                    <div class="accordion-header">
                        <span><i class="fas fa-child"></i> المستوى الابتدائي</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="accordion-content">
                        <ul class="stages-list">
                            <li class="stage-item" data-stage="1 ابتدائي"><i class="fas fa-book-open"></i> السنة الأولى ابتدائي</li>
                            <li class="stage-item" data-stage="2 ابتدائي"><i class="fas fa-book-open"></i> السنة الثانية ابتدائي</li>
                            <li class="stage-item" data-stage="3 ابتدائي"><i class="fas fa-book-open"></i> السنة الثالثة ابتدائي</li>
                            <li class="stage-item" data-stage="4 ابتدائي"><i class="fas fa-book-open"></i> السنة الرابعة ابتدائي</li>
                            <li class="stage-item" data-stage="5 ابتدائي"><i class="fas fa-book-open"></i> السنة الخامسة ابتدائي</li>
                        </ul>
                    </div>
                </div>
                
                <div class="accordion-item" data-level="متوسط">
                    <div class="accordion-header">
                        <span><i class="fas fa-graduation-cap"></i> المستوى المتوسط</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="accordion-content">
                        <ul class="stages-list">
                            <li class="stage-item" data-stage="1 متوسط"><i class="fas fa-book"></i> السنة الأولى متوسط</li>
                            <li class="stage-item" data-stage="2 متوسط"><i class="fas fa-book"></i> السنة الثانية متوسط</li>
                            <li class="stage-item" data-stage="3 متوسط"><i class="fas fa-book"></i> السنة الثالثة متوسط</li>
                            <li class="stage-item" data-stage="4 متوسط"><i class="fas fa-book-reader"></i> السنة الرابعة متوسط (BEM)</li>
                        </ul>
                    </div>
                </div>
                
                <div class="accordion-item" data-level="ثانوي">
                    <div class="accordion-header">
                        <span><i class="fas fa-university"></i> المستوى الثانوي</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="accordion-content">
                        <ul class="stages-list">
                            <li class="stage-item" data-stage="1 ثانوي - جذع مشترك"><i class="fas fa-star"></i> السنة الأولى ثانوي (جذع مشترك)</li>
                            <li class="stage-item" data-stage="2 ثانوي - آداب"><i class="fas fa-pen"></i> السنة الثانية ثانوي (آداب)</li>
                            <li class="stage-item" data-stage="2 ثانوي - علوم"><i class="fas fa-atom"></i> السنة الثانية ثانوي (علوم)</li>
                            <li class="stage-item" data-stage="2 ثانوي - تسيير واقتصاد"><i class="fas fa-chart-line"></i> السنة الثانية ثانوي (تسيير واقتصاد)</li>
                            <li class="stage-item" data-stage="2 ثانوي - لغات"><i class="fas fa-globe"></i> السنة الثانية ثانوي (لغات)</li>
                            <li class="stage-item" data-stage="3 ثانوي - آداب"><i class="fas fa-pen-nib"></i> السنة الثالثة ثانوي (آداب) - بكالوريا</li>
                            <li class="stage-item" data-stage="3 ثانوي - علوم"><i class="fas fa-microscope"></i> السنة الثالثة ثانوي (علوم) - بكالوريا</li>
                            <li class="stage-item" data-stage="3 ثانوي - تسيير واقتصاد"><i class="fas fa-calculator"></i> السنة الثالثة ثانوي (تسيير واقتصاد) - بكالوريا</li>
                            <li class="stage-item" data-stage="3 ثانوي - لغات"><i class="fas fa-language"></i> السنة الثالثة ثانوي (لغات) - بكالوريا</li>
                        </ul>
                    </div>
                </div>

            </div>
        </section>
        
        <section id="subjects-selection">
            <h4><i class="fas fa-layer-group"></i> اختيار المادة للمرحلة: <span id="selected-stage-display"></span></h4>
            <p style="margin-bottom: 15px; color: var(--primary-accent);">اضغط على المادة لفتح نموذج التسجيل.</p>
            <div class="subjects-grid">
                </div>
        </section>

        <section id="status-tracker" style="max-width: 600px; margin: 40px auto; padding: 25px; border-radius: 15px; border: 1px solid var(--glass-border-color); background: var(--glass-card-bg); text-align: center;">
            <h3 style="color: var(--primary-accent); margin-bottom: 15px;"><i class="fas fa-search"></i> متابعة حالة طلب التسجيل</h3>
            <div class="form-group" style="display: flex; gap: 10px;">
                <input type="text" id="request-id-input" placeholder="أدخل كود الطلب (المكون من 32 حرفاً)" style="flex-grow: 1;">
                <button id="track-status-btn" class="submit-btn" style="width: 150px; padding: 10px;"><i class="fas fa-sync-alt"></i> تحديث</button>
            </div>
            <div id="request-status-display" style="margin-top: 20px; text-align: right; border-top: 1px dashed var(--glass-border-color); padding-top: 15px;">
                <p style="color: var(--primary-accent); font-weight: 700;">الحالة الحالية: <span id="current-status">لا يوجد طلب مُتابع.</span></p>
                <div id="final-barcode-display" style="display: none; margin-top: 20px; text-align: center;">
                    <p style="color: greenyellow; font-weight: 700;">تمت الموافقة! يمكنك الدخول بهذا الكود.</p>
                    <p>كود الدخول (الباركود): <strong id="student-barcode-final"></strong></p>
                    <p>حالة الدفع: <strong id="payment-status-final"></strong></p>
                    <div id="simulated-barcode-final"></div>
                </div>
            </div>
        </section>

    </main>

    <div id="registration-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div id="form-view">
                <form id="enrollment-form">
                    <h4 style="text-align: center;"><i class="fas fa-user-plus"></i> نموذج طلب التسجيل</h4>
                    
                    <div class="form-info">
                        <p>المرحلة: <strong id="form-stage"></strong></p>
                        <p>المادة: <strong id="form-subject"></strong></p>
                        <p>سعر حصة الدعم: **40 دج**</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="fullName">الاسم واللقب:</label>
                        <input type="text" id="fullName" name="fullName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="phone">رقم الهاتف (للتواصل):</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>

                    <input type="hidden" id="hidden-stage" name="stage">
                    <input type="hidden" id="hidden-subject" name="subject">
                    <input type="hidden" name="price" value="40">
                    
                    <button type="submit" class="submit-btn"><i class="fas fa-paper-plane"></i> إرسال طلب التسجيل</button>
                    <div id="form-message" style="margin-top: 15px; color: var(--primary-accent); font-weight: 700; text-align: center;"></div>
                </form>
            </div>
            
            <div id="barcode-view" style="display: none; text-align: center;">
                <h4 style="color: var(--primary-accent);"><i class="fas fa-check-circle"></i> تم إرسال طلبك!</h4>
                <p style="margin: 15px 0;">تم تسجيل طلبك. حالته **معلق**. يرجى حفظ الكود التالي لمتابعة حالة طلبك:</p>
                <div id="barcode-container">
                    <p>كود الطلب (ID): <strong id="request-id-display"></strong></p>
                    <small style="display: block; margin-top: 15px; color: var(--primary-accent);">عند الموافقة من الأدمن، سيظهر كود البار في شاشة متابعة الحالة.</small>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const accordionHeaders = document.querySelectorAll('.accordion-header');
            const stageItems = document.querySelectorAll('.stage-item');
            const subjectsSelection = document.getElementById('subjects-selection');
            const subjectsGrid = subjectsSelection.querySelector('.subjects-grid');
            const selectedStageDisplay = document.getElementById('selected-stage-display');
            
            const modal = document.getElementById('registration-modal');
            const closeButton = document.querySelector('.close-button');
            const enrollmentForm = document.getElementById('enrollment-form');
            const formView = document.getElementById('form-view');
            const barcodeView = document.getElementById('barcode-view');
            const formStageDisplay = document.getElementById('form-stage');
            const formSubjectDisplay = document.getElementById('form-subject');
            const hiddenStageInput = document.getElementById('hidden-stage');
            const hiddenSubjectInput = document.getElementById('hidden-subject');
            const formMessage = document.getElementById('form-message');
            const requestIdDisplay = document.getElementById('request-id-display');

            // عناصر متابعة الحالة
            const requestIdInput = document.getElementById('request-id-input');
            const trackStatusBtn = document.getElementById('track-status-btn');
            const currentStatusDisplay = document.getElementById('current-status');
            const finalBarcodeDisplay = document.getElementById('final-barcode-display');
            const studentBarcodeFinal = document.getElementById('student-barcode-final');
            const paymentStatusFinal = document.getElementById('payment-status-final');
            const simulatedBarcodeFinal = document.getElementById('simulated-barcode-final');


            let selectedStage = null;
            let selectedSubject = null;

            // تحديد المواد المتاحة لكل مرحلة
            const generalSubjects = ['رياضيات', 'لغة عربية', 'لغة إنجليزية', 'لغة فرنسية'];
            const scienceSubjects = ['رياضيات', 'فيزياء', 'علوم طبيعية', 'لغة إنجليزية', 'لغة فرنسية'];
            const literatureSubjects = ['لغة عربية', 'فلسفة', 'لغة إنجليزية', 'لغة فرنسية', 'تاريخ وجغرافيا'];
            const ecoSubjects = ['اقتصاد', 'محاسبة', 'رياضيات', 'تسيير مالي', 'لغة إنجليزية'];
            const languageSubjects = ['لغة عربية', 'لغة إنجليزية', 'لغة فرنسية', 'لغة ألمانية', 'لغة إسبانية'];

            const getSubjectsForStage = (stage) => {
                if (stage.includes('ابتدائي')) return ['رياضيات', 'لغة عربية', 'لغة إنجليزية', 'لغة فرنسية'];
                if (stage.includes('متوسط')) return ['رياضيات', 'لغة عربية', 'لغة إنجليزية', 'لغة فرنسية', 'فيزياء/علوم'];
                if (stage.includes('1 ثانوي')) return generalSubjects; 
                if (stage.includes('علوم')) return scienceSubjects;
                if (stage.includes('آداب')) return literatureSubjects;
                if (stage.includes('تسيير واقتصاد')) return ecoSubjects;
                if (stage.includes('لغات')) return languageSubjects;
                return generalSubjects; 
            };
            
            // دالة محاكاة الباركود
            const generateSimulatedBarcode = (container, code) => {
                container.innerHTML = '';
                // محاكاة كود بار بلون أبيض على الخلفية السوداء
                for (let i = 0; i < 20; i++) {
                    const bar = document.createElement('div');
                    bar.classList.add('bar');
                    const height = Math.floor(Math.random() * (80 - 40 + 1) + 40);
                    bar.style.height = `${height}px`;
                    bar.style.width = `${Math.random() > 0.5 ? 4 : 2}px`; 
                    container.appendChild(bar);
                }
            };

            // منطق الأكورديون (إظهار/إخفاء المحتوى)
            accordionHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const item = header.closest('.accordion-item');
                    const content = item.querySelector('.accordion-content');
                    
                    document.querySelectorAll('.accordion-item').forEach(otherItem => {
                        if (otherItem !== item && otherItem.classList.contains('open')) {
                            otherItem.classList.remove('open');
                            otherItem.querySelector('.accordion-content').style.maxHeight = 0;
                        }
                    });

                    if (item.classList.contains('open')) {
                        item.classList.remove('open');
                        content.style.maxHeight = 0;
                    } else {
                        item.classList.add('open');
                        content.style.maxHeight = content.scrollHeight + "px";
                    }
                });
            });

            // معالجة النقر على المرحلة الدراسية (فتح اختيار المواد)
            stageItems.forEach(item => {
                item.addEventListener('click', () => {
                    stageItems.forEach(s => s.classList.remove('selected'));
                    item.classList.add('selected');
                    
                    selectedStage = item.dataset.stage;
                    
                    selectedStageDisplay.textContent = `${selectedStage}`;
                    
                    subjectsGrid.innerHTML = ''; 
                    selectedSubject = null;
                    
                    subjectsSelection.style.display = 'block';
                    
                    const subjects = getSubjectsForStage(selectedStage);
                    subjects.forEach(subject => {
                        const button = document.createElement('button');
                        button.textContent = subject;
                        button.classList.add('subject-button');
                        button.dataset.subject = subject;
                        subjectsGrid.appendChild(button);
                        
                        button.addEventListener('click', (e) => {
                            e.preventDefault(); 
                            handleSubjectSelection(subject);
                        });
                    });
                    
                    subjectsSelection.scrollIntoView({ behavior: 'smooth' });
                });
            });
            
            // معالجة النقر على المادة (إظهار المودال)
            const handleSubjectSelection = (subject) => {
                subjectsGrid.querySelectorAll('.subject-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                const currentButton = subjectsGrid.querySelector(`[data-subject="${subject}"]`);
                if (currentButton) {
                    currentButton.classList.add('selected');
                }
                
                selectedSubject = subject;
                
                formStageDisplay.textContent = selectedStage;
                formSubjectDisplay.textContent = selectedSubject;
                hiddenStageInput.value = selectedStage;
                hiddenSubjectInput.value = selectedSubject;
                
                formView.style.display = 'block';
                barcodeView.style.display = 'none';
                enrollmentForm.reset();
                formMessage.textContent = '';
                modal.style.display = 'block';
            };

            // منطق المودال (الإغلاق)
            closeButton.onclick = function() {
                modal.style.display = "none";
            }

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }

            // معالجة إرسال النموذج (POST /api/register)
            enrollmentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                formMessage.textContent = '... جاري إرسال الطلب إلى الأدمن';
                
                const formData = new FormData(enrollmentForm);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch('/api/register', { 
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        formMessage.textContent = ''; 

                        // عرض شاشة كود الطلب المعلق
                        requestIdDisplay.textContent = result.requestId;
                        formView.style.display = 'none';
                        barcodeView.style.display = 'block';
                        
                        // وضع ID الطلب في حقل المتابعة تلقائيًا
                        requestIdInput.value = result.requestId;

                    } else {
                        formMessage.textContent = `❌ خطأ: ${result.message}`;
                    }
                } catch (error) {
                    console.error('خطأ في إرسال البيانات:', error);
                    formMessage.textContent = '❌ فشل الاتصال بالخادم. يرجى التحقق من اتصالك.';
                }
            });
            
            // متابعة حالة الطلب (GET /api/status/:id)
            trackStatusBtn.addEventListener('click', async () => {
                const requestId = requestIdInput.value.trim();
                if (!requestId) {
                    currentStatusDisplay.textContent = 'الرجاء إدخال كود الطلب.';
                    finalBarcodeDisplay.style.display = 'none';
                    return;
                }
                
                currentStatusDisplay.textContent = 'جاري التحقق...';
                
                try {
                    const response = await fetch(`/api/status/${requestId}`);
                    const result = await response.json();
                    
                    finalBarcodeDisplay.style.display = 'none';
                    simulatedBarcodeFinal.innerHTML = '';
                    
                    if (result.success) {
                        let statusText = '';
                        let statusColor = 'var(--primary-accent)';
                        
                        // تحديث عرض الحالة
                        if (result.status === 'approved') {
                            statusText = `تمت الموافقة! ✅ مادتك: ${result.subject}.`;
                            statusColor = 'greenyellow';
                        } else if (result.status === 'rejected') {
                            statusText = 'تم رفض الطلب. ❌';
                            statusColor = 'red';
                        } else {
                            statusText = 'معلق. ⏳ يرجى الانتظار لموافقة الأدمن.';
                            statusColor = 'orange';
                        }
                        
                        currentStatusDisplay.textContent = statusText;
                        currentStatusDisplay.style.color = statusColor;
                        
                        // عرض كود البار وحالة الدفع إذا تمت الموافقة
                        if (result.status === 'approved' && result.barcode) {
                            studentBarcodeFinal.textContent = result.barcode;
                            paymentStatusFinal.textContent = result.paymentStatus === 'paid' ? 'تم الدفع' : 'لم يتم الدفع';
                            paymentStatusFinal.style.color = result.paymentStatus === 'paid' ? 'greenyellow' : 'red';
                            
                            generateSimulatedBarcode(simulatedBarcodeFinal, result.barcode);
                            finalBarcodeDisplay.style.display = 'block';
                            
                        }
                        
                    } else {
                        currentStatusDisplay.textContent = 'الطلب غير موجود. تأكد من الكود.';
                        currentStatusDisplay.style.color = 'red';
                    }
                    
                } catch (error) {
                    console.error('خطأ في متابعة الحالة:', error);
                    currentStatusDisplay.textContent = 'فشل الاتصال بالخادم لمتابعة الحالة.';
                    currentStatusDisplay.style.color = 'red';
                }
            });
        });
    </script>
</body>
</html>
