<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>أكاديمية المعالي</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

<style>
/* CSS styles */
:root{
  --bg: #0b0b0c;
  --drawer-bg: #151517;
  --text-primary: #ffffff;
  --text-secondary: #a1a1aa;
  --border-color: rgba(255,255,255,0.08);
  --accent-color: #3b82f6; 
  --danger-color: #ef4444;
  --success-color: #43cf66;
  --nav-height: 72px;
  --radius: 12px;
}

*{box-sizing:border-box;}

html,body{
  height:100%;
  margin:0;
  font-family: "Tajawal", sans-serif;
  background-color: var(--bg);
  background-image: 
    radial-gradient(circle at 15% 50%, rgba(255, 255, 255, 0.03) 0%, transparent 25%),
    radial-gradient(circle at 85% 50%, rgba(255, 255, 255, 0.03) 0%, transparent 25%);
  color: var(--text-primary);
}

header{
  height:var(--nav-height);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 20px;
  border-bottom:1px solid var(--border-color);
}

header .title{
  font-size:1.5rem;
  font-weight:700;
}

.controls{
  display:flex;
  gap:10px;
}

/* --- زر عام مرن --- */
.btn {
    padding: 10px 18px;
    border: none;
    border-radius: var(--radius);
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
    font-family: "Tajawal", sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary {
    background-color: var(--accent-color);
    color: var(--text-primary);
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
}
.btn-primary:hover {
    background-color: #2563eb;
    transform: translateY(-1px);
}
.btn-primary:active {
    background-color: #1e40af;
    transform: translateY(0);
    box-shadow: none;
}

.btn-secondary {
    background-color: var(--drawer-bg);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
}
.btn-secondary:hover {
    background-color: #29292c;
    color: var(--text-primary);
}

.main-content{
  padding:20px;
}

/* --- بطاقة الطالب --- */
.student-card {
    background-color: var(--drawer-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    position: relative; /* هام لتموضع قائمة الإجراءات */
}
.student-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.student-card .name {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text-primary);
}
.student-card .details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: 8px;
}
.student-card .subjects {
    font-size: 0.9rem;
    color: var(--text-secondary);
    line-height: 1.5;
}

.status-indicator {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
}
.status-active {
    background-color: rgba(67, 207, 102, 0.15);
    color: var(--success-color);
}
.status-inactive {
    background-color: rgba(239, 68, 68, 0.15);
    color: var(--danger-color);
}

/* --- نافذة التسجيل (Glassmorphism) --- */
.drawer {
    position: fixed;
    top: 0;
    right: -100%;
    width: 400px;
    max-width: 90%;
    height: 100%;
    background: rgba(21, 21, 23, 0.8); /* خلفية شبه شفافة */
    backdrop-filter: blur(10px); /* تأثير الزجاج */
    -webkit-backdrop-filter: blur(10px);
    border-right: 1px solid var(--border-color);
    box-shadow: -10px 0 30px rgba(0, 0, 0, 0.3);
    transition: right 0.3s ease-in-out;
    z-index: 1000;
    padding: 20px;
    overflow-y: auto;
}
.drawer.open {
    right: 0;
}
.drawer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 15px;
}
.drawer-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
}
.drawer-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    transition: color 0.2s;
}
.drawer-close:hover {
    color: var(--text-primary);
}

/* --- حقول الإدخال --- */
.form-group {
    margin-bottom: 15px;
}
.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-secondary);
}
.form-group input,
.form-group select {
    width: 100%;
    padding: 12px;
    border-radius: var(--radius);
    border: 1px solid var(--border-color);
    background-color: var(--drawer-bg);
    color: var(--text-primary);
    font-family: "Tajawal", sans-serif;
    font-size: 1rem;
    transition: border-color 0.2s;
}
.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--accent-color);
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

/* --- قائمة الإجراءات (3 نقاط) --- */
.action-menu {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 10;
}
.action-menu-toggle {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px;
    line-height: 1;
    transition: color 0.2s;
}
.action-menu-toggle:hover {
    color: var(--text-primary);
}

.action-menu-dropdown {
    position: absolute;
    left: 0;
    top: 35px;
    background-color: var(--drawer-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    min-width: 150px;
    display: none;
    z-index: 20;
    overflow: hidden;
}
.action-menu-dropdown.active {
    display: block;
}

.action-menu-dropdown button {
    width: 100%;
    padding: 10px 15px;
    text-align: right;
    background: none;
    border: none;
    color: var(--text-primary);
    cursor: pointer;
    font-family: "Tajawal", sans-serif;
    font-size: 0.9rem;
    transition: background-color 0.2s;
}
.action-menu-dropdown button:hover {
    background-color: rgba(255, 255, 255, 0.05);
}
.action-menu-dropdown .delete-action {
    color: var(--danger-color);
}

/* (إضافة أنماط تنبيهات وتأكيدات مخصصة هنا إذا لزم الأمر) */


</style>
</head>

<body>

<header>
  <div class="title">أكاديمية المعالي</div>
  <div class="controls">
      <button class="btn btn-secondary" id="open-scanner-btn">مسح QR</button>
      <button class="btn btn-primary" id="open-drawer-btn">تسجيل طالب جديد</button>
  </div>
</header>

<div class="main-content">
  <div id="loading-message" style="text-align: center; color: var(--text-secondary); margin-top: 50px;">
      جارٍ تحميل بيانات الطلاب...
  </div>
  <div id="student-cards-container">
      </div>
</div>

<div id="registration-drawer" class="drawer">
  <div class="drawer-header">
    <h2>تسجيل طالب جديد</h2>
    <button class="drawer-close" id="close-drawer-btn">×</button>
  </div>

  <form id="registration-form">
    
    <div class="form-group">
      <label for="name">الاسم</label>
      <input type="text" id="name" name="name" required>
    </div>

    <div class="form-group">
      <label for="lastName">اللقب</label>
      <input type="text" id="lastName" name="lastName" required>
    </div>

    <div class="form-group">
      <label for="phase">المرحلة الدراسية</label>
      <select id="phase" name="phase" required>
        <option value="">اختر المرحلة</option>
        </select>
    </div>

    <div class="form-group">
      <label for="year">السنة الدراسية</label>
      <select id="year" name="year" required disabled>
        <option value="">اختر السنة</option>
        </select>
    </div>

    <div class="form-group">
      <label for="stream">الشعبة (إن وجدت)</label>
      <select id="stream" name="stream" required disabled>
        <option value="عامة">عامة</option>
        </select>
    </div>

    <div id="subjects-container">
      <h3>المواد المشتركة وعدد الحصص</h3>
      </div>
    
    <div class="form-actions">
        <button type="button" class="btn btn-secondary" id="cancel-reg-btn">إلغاء</button>
        <button type="submit" class="btn btn-primary" id="submit-reg-btn">تسجيل وحفظ</button>
    </div>

    <div id="qr-code-display" style="text-align: center; margin-top: 20px; display: none;">
      <p id="reg-status-message" style="font-weight: bold;"></p>
      <img id="qr-code-img" src="" alt="QR Code" style="max-width: 100%; height: auto; border: 1px solid var(--border-color); border-radius: var(--radius); margin-top: 10px;">
    </div>

  </form>
</div>

<div id="scanner-container" style="display:none; text-align:center; padding: 20px;">
  <h2>ماسح رمز QR للحضور</h2>
  <div id="reader" style="width: 300px; margin: 20px auto; border: 1px solid var(--border-color); border-radius: var(--radius);"></div>
  <button class="btn btn-secondary" id="close-scanner-btn">إغلاق الماسح</button>
  <p id="scan-result" style="margin-top: 15px; font-weight: 500;"></p>
</div>

<div id="custom-alert-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; justify-content:center; align-items:center;">
    <div id="custom-alert-box" style="background:var(--drawer-bg); padding:25px; border-radius:var(--radius); width:350px; max-width:90%; border:1px solid var(--border-color); text-align:center;">
        <h3 id="custom-alert-title" style="margin-top:0; font-size:1.2rem;">تنبيه</h3>
        <p id="custom-alert-message" style="color:var(--text-secondary); margin-bottom:20px;"></p>
        <div id="custom-alert-actions" style="display:flex; justify-content:center; gap:10px;">
            <button id="custom-alert-ok" class="btn btn-primary" style="width:100px;">حسناً</button>
            <button id="custom-alert-cancel" class="btn btn-secondary" style="width:100px; display:none;">إلغاء</button>
        </div>
    </div>
</div>

<script>
  let COURSES_DATA = {};
  const studentCardsContainer = document.getElementById('student-cards-container');
  const loadingMessage = document.getElementById('loading-message');
  const studentPhaseSelect = document.getElementById('phase');
  const studentYearSelect = document.getElementById('year');
  const studentStreamSelect = document.getElementById('stream');
  const subjectsContainer = document.getElementById('subjects-container');
  const registrationDrawer = document.getElementById('registration-drawer');
  const regForm = document.getElementById('registration-form');
  const regStatusMessage = document.getElementById('reg-status-message');
  const qrCodeImg = document.getElementById('qr-code-img');
  const qrCodeDisplay = document.getElementById('qr-code-display');
  const openDrawerBtn = document.getElementById('open-drawer-btn');
  const closeDrawerBtn = document.getElementById('close-drawer-btn');
  const cancelRegBtn = document.getElementById('cancel-reg-btn');
  const scannerContainer = document.getElementById('scanner-container');
  const openScannerBtn = document.getElementById('open-scanner-btn');
  const closeScannerBtn = document.getElementById('close-scanner-btn');
  const scanResult = document.getElementById('scan-result');
  
  let html5QrcodeScanner = null;


  // --- تنبيهات وتأكيدات مخصصة ---
  function showCustomAlert(message, title = 'تنبيه', isConfirm = false, callback = () => {}) {
      const overlay = document.getElementById('custom-alert-overlay');
      const box = document.getElementById('custom-alert-box');
      const msg = document.getElementById('custom-alert-message');
      const alertTitle = document.getElementById('custom-alert-title');
      const okBtn = document.getElementById('custom-alert-ok');
      const cancelBtn = document.getElementById('custom-alert-cancel');
      
      alertTitle.textContent = title;
      msg.textContent = message;
      cancelBtn.style.display = isConfirm ? 'inline-block' : 'none';
      okBtn.textContent = isConfirm ? 'تأكيد' : 'حسناً';

      overlay.style.display = 'flex';
      
      okBtn.onclick = () => {
          overlay.style.display = 'none';
          if (isConfirm) callback(true);
      };
      
      cancelBtn.onclick = () => {
          overlay.style.display = 'none';
          callback(false);
      };
  }

  // --- دالة مساعدة لإنشاء عناصر النموذج ---
  function createSubjectInput(subjectName, maxSessions) {
    const div = document.createElement('div');
    div.classList.add('form-group');
    div.innerHTML = `
        <label for="session-${subjectName}">${subjectName} (الحد الأقصى: ${maxSessions})</label>
        <input 
            type="number" 
            id="session-${subjectName}" 
            name="session-${subjectName}" 
            min="1" 
            max="${maxSessions}" 
            value="1" 
            required
        >
    `;
    return div;
  }

  // --- دوال فتح وإغلاق النافذة الجانبية ---
  function openDrawer() {
      registrationDrawer.classList.add('open');
      resetRegistrationForm();
  }

  function closeDrawer() {
      registrationDrawer.classList.remove('open');
      resetRegistrationForm();
  }
  
  // --- إعادة ضبط النموذج ---
  function resetRegistrationForm() {
      regForm.reset();
      regStatusMessage.textContent = '';
      regStatusMessage.style.color = '';
      qrCodeDisplay.style.display = 'none';
      studentYearSelect.disabled = true;
      studentStreamSelect.disabled = true;
      subjectsContainer.innerHTML = '<h3>المواد المشتركة وعدد الحصص</h3>';
  }

  // --- منطق تعبئة المواد ---
  function populateSubjects() {
      subjectsContainer.innerHTML = '<h3>المواد المشتركة وعدد الحصص</h3>';

      const phase = studentPhaseSelect.value;
      const year = studentYearSelect.value;
      const stream = studentStreamSelect.value;

      if (phase && year && stream) {
          const streamCourses = COURSES_DATA[phase]?.[year]?.[stream];
          const generalCourses = COURSES_DATA[phase]?.[year]?.['عامة'];

          let subjectsList = [];
          if (generalCourses) {
              subjectsList = subjectsList.concat(generalCourses);
          }
          if (streamCourses && streamCourses !== generalCourses) {
              subjectsList = subjectsList.concat(streamCourses);
          }
          
          subjectsList = [...new Set(subjectsList)]; // إزالة التكرارات

          if (subjectsList.length > 0) {
              subjectsList.forEach(subject => {
                  // هنا يمكنك تحديد الحد الأقصى للحصص. نستخدم 50 كقيمة افتراضية عالية.
                  subjectsContainer.appendChild(createSubjectInput(subject, 50)); 
              });
          } else {
              subjectsContainer.innerHTML += '<p style="color:var(--danger-color);">لا توجد مواد متاحة لهذه الشعبة.</p>';
          }
      }
  }


  // --- معالجات تغيير النموذج ---
  studentPhaseSelect.addEventListener('change', () => {
      studentYearSelect.innerHTML = '<option value="">اختر السنة</option>';
      studentYearSelect.disabled = true;
      studentStreamSelect.innerHTML = '<option value="عامة">عامة</option>';
      studentStreamSelect.disabled = true;
      subjectsContainer.innerHTML = '<h3>المواد المشتركة وعدد الحصص</h3>';

      const phase = studentPhaseSelect.value;
      if (phase && COURSES_DATA[phase]) {
          Object.keys(COURSES_DATA[phase]).forEach(year => {
              const option = document.createElement('option');
              option.value = year;
              option.textContent = year;
              studentYearSelect.appendChild(option);
          });
          studentYearSelect.disabled = false;
      }
  });

  studentYearSelect.addEventListener('change', () => {
      studentStreamSelect.innerHTML = '<option value="عامة">عامة</option>';
      studentStreamSelect.disabled = true;
      subjectsContainer.innerHTML = '<h3>المواد المشتركة وعدد الحصص</h3>';
      
      const phase = studentPhaseSelect.value;
      const year = studentYearSelect.value;

      if (phase && year && COURSES_DATA[phase][year]) {
          const streams = Object.keys(COURSES_DATA[phase][year]);
          if (streams.length > 1 || (streams.length === 1 && streams[0] !== 'عامة')) {
              streams.filter(s => s !== 'عامة').forEach(stream => {
                  const option = document.createElement('option');
                  option.value = stream;
                  option.textContent = stream;
                  studentStreamSelect.appendChild(option);
              });
              studentStreamSelect.disabled = false;
          }
          // تعبئة أولية للمواد (إذا كانت عامة)
          populateSubjects(); 
      }
  });

  studentStreamSelect.addEventListener('change', populateSubjects);


  // --- معالج إرسال النموذج ---
  regForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      regStatusMessage.textContent = '...جارٍ التسجيل';
      regStatusMessage.style.color = var('--accent-color');
      qrCodeDisplay.style.display = 'block';
      qrCodeImg.style.display = 'none'; 
      document.getElementById('submit-reg-btn').disabled = true;

      const formData = new FormData(regForm);
      const subjects = [];

      // جمع بيانات المواد
      for (let [key, value] of formData.entries()) {
          if (key.startsWith('session-')) {
              const subjectName = key.replace('session-', '');
              subjects.push({
                  name: subjectName,
                  sessionCount: parseInt(value, 10) // يجب أن تكون أرقام
              });
          }
      }

      const registrationData = {
          name: formData.get('name'),
          lastName: formData.get('lastName'),
          phase: formData.get('phase'),
          year: formData.get('year'),
          stream: formData.get('stream'),
          subjects: subjects
      };
      
      try {
          const response = await fetch('/register', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(registrationData)
          });
          
          const result = await response.json();

          if (response.ok) {
              regStatusMessage.textContent = `نجاح! تم تسجيل الطالب ${registrationData.name} ${registrationData.lastName}.`;
              regStatusMessage.style.color = var('--success-color');
              qrCodeImg.src = result.qrCodeUrl;
              qrCodeImg.style.display = 'block';
              fetchStudentCards(); // تحديث قائمة الطلاب
          } else {
              regStatusMessage.textContent = `خطأ في التسجيل: ${result.message || 'فشل غير معروف'}`;
              regStatusMessage.style.color = var('--danger-color');
              qrCodeDisplay.style.display = 'block';
              qrCodeImg.style.display = 'none';
          }
      } catch (error) {
          console.error('Registration failed:', error);
          regStatusMessage.textContent = 'فشل في الاتصال بالخادم.';
          regStatusMessage.style.color = var('--danger-color');
      } finally {
          document.getElementById('submit-reg-btn').disabled = false;
      }
  });


  // --- دالة جلب وعرض بطاقات الطلاب (مُحدثة لدعم زر الحذف) ---
  async function fetchStudentCards() {
      loadingMessage.textContent = 'جارٍ تحميل بيانات الطلاب...';
      studentCardsContainer.innerHTML = '';
      loadingMessage.style.display = 'block';

      try {
          const response = await fetch('/students');
          if (!response.ok) throw new Error('Failed to fetch students data');
          
          const students = await response.json();
          loadingMessage.style.display = 'none';

          const studentArray = Object.values(students);
          if (studentArray.length === 0) {
              loadingMessage.textContent = 'لا يوجد طلاب مسجلون بعد.';
              loadingMessage.style.display = 'block';
              return;
          }

          // فرز الطلاب حسب التاريخ الأحدث أولاً
          studentArray.sort((a, b) => b.registeredAt - a.registeredAt);

          for (const student of studentArray) {
              const id = student.id;
              
              const card = document.createElement('div');
              card.classList.add('student-card');

              // إضافة قائمة الإجراءات (3 نقاط)
              const actionMenu = document.createElement('div');
              actionMenu.classList.add('action-menu');
              actionMenu.innerHTML = `
                  <button class="action-menu-toggle" aria-expanded="false" aria-controls="menu-${id}">•••</button>
                  <div class="action-menu-dropdown" id="menu-${id}">
                      <button class="delete-action" data-student-id="${id}">حذف الطالب</button>
                  </div>
              `;
              card.appendChild(actionMenu);

              const detailsText = `${student.phase || ''} | ${student.year || ''} | ${student.stream && student.stream !== 'عامة' ? student.stream : ''}`;
              
              const totalCompleted = student.subjects ? student.subjects.reduce((sum, s) => sum + s.completedSessions, 0) : 0;
              const totalRequired = student.subjects ? student.subjects.reduce((sum, s) => sum + s.totalSessions, 0) : 0;
              
              const statusText = totalCompleted < totalRequired ? 'مفعل' : 'مكتمل الحصص';
              const statusClass = totalCompleted < totalRequired ? 'status-active' : 'status-inactive';

              const subjectSummary = student.subjects 
                                        ? student.subjects.map(s => `${s.name} (${s.completedSessions}/${s.totalSessions})`).join(' | ') 
                                        : 'لا توجد مواد';


              card.innerHTML += `
                  <div class="name">${student.name}</div>
                  <div class="details">
                      <span>${detailsText.trim().replace(/\|\s*\|/g, ' | ').trim()}</span>
                      <span class="status-indicator ${statusClass}">${statusText}</span>
                  </div>
                  <div class="subjects"><strong>ملخص الحصص:</strong> ${subjectSummary}</div>
              `;
              
              // لجعل النقر على البطاقة (عدا قائمة الإجراءات) ينقلك إلى الملف الشخصي
              card.addEventListener('click', (e) => {
                  // إذا لم يكن النقر على زر الإجراءات، انتقل للصفحة
                  if (!e.target.closest('.action-menu-toggle') && !e.target.closest('.action-menu-dropdown')) {
                      window.location.href = `/profile.html?id=${id}`;
                  }
              });

              // منطق قائمة الإجراءات (الـ 3 نقاط)
              const toggleButton = actionMenu.querySelector('.action-menu-toggle');
              const dropdown = actionMenu.querySelector('.action-menu-dropdown');
              
              toggleButton.addEventListener('click', (e) => {
                  e.stopPropagation(); // منع انتقال الصفحة عند النقر على الزر
                  // إغلاق أي قوائم مفتوحة أخرى
                  document.querySelectorAll('.action-menu-dropdown.active').forEach(d => {
                      if (d !== dropdown) d.classList.remove('active');
                  });
                  dropdown.classList.toggle('active');
              });

              // منطق زر حذف الطالب
              const deleteButton = actionMenu.querySelector('.delete-action');
              deleteButton.addEventListener('click', (e) => {
                  e.stopPropagation(); // منع انتقال الصفحة
                  dropdown.classList.remove('active'); // إغلاق القائمة

                  showCustomAlert(
                      `هل أنت متأكد من حذف الطالب **${student.name}** وسجل حضوره بالكامل؟`,
                      'تأكيد حذف الطالب',
                      true, // هو تأكيد
                      (isConfirmed) => {
                          if (isConfirmed) {
                              deleteStudent(id, student.name);
                          }
                      }
                  );
              });
              
              studentCardsContainer.appendChild(card);
          }
          
      } catch (error) {
          console.error('Error fetching student cards:', error);
          loadingMessage.textContent = 'فشل في تحميل بيانات الطلاب.';
          loadingMessage.style.display = 'block';
      }
  }


  // --- دالة حذف الطالب ---
  async function deleteStudent(studentId, studentName) {
      try {
          const response = await fetch(`/student/${studentId}`, {
              method: 'DELETE'
          });

          if (response.ok) {
              showCustomAlert(`تم حذف الطالب **${studentName}** بنجاح.`, 'نجاح');
              fetchStudentCards(); // تحديث القائمة
          } else {
              const error = await response.json();
              showCustomAlert(`فشل الحذف: ${error.message}`, 'خطأ في الحذف');
          }
      } catch (error) {
          showCustomAlert('خطأ في الاتصال بالخادم عند محاولة الحذف.', 'خطأ شبكة');
      }
  }


  // --- منطق ماسح QR Code ---
  function onScanSuccess(decodedText, decodedResult) {
      // إيقاف الماسح لمنع القراءة المتعددة
      html5QrcodeScanner.pause(true); 

      // التوجيه إلى صفحة الملف الشخصي باستخدام المعرف الذي تم مسحه
      // (نستخدم decodedText مباشرة لأنه أصبح ID نظيف الآن بفضل التعديلات السابقة في server.js)
      window.location.href = `/profile.html?id=${decodedText}`;
  }

  function onScanError(errorMessage) {
      // يمكنك عرض رسالة خطأ بسيطة
      // console.error(`QR Scan Error: ${errorMessage}`);
  }

  function openScanner() {
      scannerContainer.style.display = 'block';
      
      // تهيئة الماسح إذا لم يكن مهيأ بعد
      if (!html5QrcodeScanner) {
          html5QrcodeScanner = new Html5QrcodeScanner(
              "reader", { fps: 10, qrbox: 250 }, false);
      }
      
      // إعادة التشغيل في كل مرة
      html5QrcodeScanner.render(onScanSuccess, onScanError);
  }

  function closeScanner() {
      scannerContainer.style.display = 'none';
      if (html5QrcodeScanner) {
          // إيقاف الماسح تمامًا
          html5QrcodeScanner.clear().catch(error => {
               // تجاهل الأخطاء إذا لم يتم تشغيل الكاميرا بعد
               console.warn("Failed to clear html5QrcodeScanner:", error);
          });
          html5QrcodeScanner = null; // إعادة تعيينه لإعادة التهيئة عند الفتح مجدداً
      }
  }

  // --- معالجات أحداث الأزرار ---
  openDrawerBtn.addEventListener('click', openDrawer);
  closeDrawerBtn.addEventListener('click', closeDrawer);
  cancelRegBtn.addEventListener('click', closeDrawer);
  openScannerBtn.addEventListener('click', openScanner);
  closeScannerBtn.addEventListener('click', closeScanner);
  
  // إغلاق قائمة الإجراءات عند النقر في أي مكان آخر
  document.addEventListener('click', (e) => {
      if (!e.target.closest('.action-menu')) {
          document.querySelectorAll('.action-menu-dropdown.active').forEach(d => {
              d.classList.remove('active');
          });
      }
  });


  // --- التحميل الأولي ---
  async function initialLoad() {
    try {
        const response = await fetch('/courses');
        COURSES_DATA = await response.json();
        
        // تعبئة قائمة المراحل
        Object.keys(COURSES_DATA).forEach(phase => {
            const option = document.createElement('option');
            option.value = phase;
            option.textContent = phase;
            studentPhaseSelect.appendChild(option);
        });

        fetchStudentCards();
    } catch (error) {
        console.error('Initial load failed:', error);
        loadingMessage.textContent = 'فشل في تحميل الإعدادات الأساسية والمواد.';
    }
  }

  initialLoad();
  
</script>
</body>

</html>
