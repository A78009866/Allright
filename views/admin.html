<!doctype html>

<html lang="ar" dir="rtl">  
<head>  
<meta charset="utf-8">  
<meta name="viewport" content="width=device-width,initial-scale=1">  
<title>Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„Ù…Ø¹Ø§Ù„ÙŠ - Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>  
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">  
<style>  
:root{  
  --bg: #0b0b0c;  
  --drawer-bg: #151517;  
  --text-primary: #ffffff;  
  --text-secondary: #a1a1aa;  
  --border-color: rgba(255,255,255,0.08);  
  --accent-color: #3b82f6;   
  --success-color: #10b981;
  --error-color: #ef4444;
  --pending-color: #f59e0b;
  --radius: 12px;  
}  
  
*{box-sizing:border-box;}  
  
html,body{  
  height:100%;  
  margin:0;  
  font-family: "Tajawal", sans-serif;  
  background-color: var(--bg);  
  color: var(--text-primary);  
}  
  
.site-container{  
  padding: 20px;  
  max-width: 1200px;  
  margin: auto;  
}  

.header {
    text-align: center;
    padding: 40px 0 20px;
}
.header h1 {
    font-size: 2.5rem;
    color: var(--accent-color);
    margin-bottom: 5px;
}
.header p {
    color: var(--text-secondary);
}

.section{  
  background-color: var(--drawer-bg);  
  padding: 20px;  
  border-radius: var(--radius);  
  margin-bottom: 25px;  
  border: 1px solid var(--border-color);
}  
  
.section-title{  
  font-size: 1.5rem;  
  margin-top: 0;  
  margin-bottom: 15px;  
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border-color);
}

.input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.input-group input[type="text"], .input-group input[type="password"] {
    flex-grow: 1;
    padding: 12px;
    background-color: var(--bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
}

.main-button {
    background-color: var(--accent-color);
    color: var(--text-primary);
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    transition: background-color 0.2s;
}

.main-button:hover {
    background-color: #5c99ff;
}

#registrations-list {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 0.9rem;
}

#registrations-list th, #registrations-list td {
    padding: 12px 15px;
    text-align: right;
    border-bottom: 1px solid var(--border-color);
}

#registrations-list th {
    background-color: var(--bg);
    color: var(--text-secondary);
    font-weight: 500;
}

.status-tag {
    display: inline-block;
    padding: 5px 10px;
    border-radius: 6px;
    font-weight: 700;
    text-align: center;
    min-width: 80px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.status-accepted {
    background-color: rgba(16, 185, 129, 0.15);
    color: var(--success-color);
    border: 1px solid var(--success-color);
}
.status-pending {
    background-color: rgba(245, 158, 11, 0.15);
    color: var(--pending-color);
    border: 1px solid var(--pending-color);
}
.status-rejected {
    background-color: rgba(239, 68, 68, 0.15);
    color: var(--error-color);
    border: 1px solid var(--error-color);
}

.status-tag:hover {
    opacity: 0.8;
}

.action-menu {
    position: absolute;
    background-color: var(--drawer-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 50;
    display: none;
    padding: 5px;
}

.action-menu button {
    display: block;
    width: 100%;
    padding: 8px 15px;
    background: none;
    border: none;
    color: var(--text-primary);
    text-align: right;
    cursor: pointer;
    border-radius: 6px;
    transition: background-color 0.2s;
}

.action-menu button:hover {
    background-color: var(--bg);
}

#loading-indicator {
    text-align: center;
    padding: 20px;
    display: none;
}

#admin-message-box {
    margin-bottom: 20px;
}

</style>  
</head>  
<body>  

<div class="site-container">  
    <header class="header">
        <h1>ğŸ”‘ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª</h1>
        <p>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„ØªÙ‡Ø§.</p>
    </header>

    <section class="section">
        <h2 class="section-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª</h2>

        <div class="input-group">
            <input type="password" id="admin-secret-input" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠ (ADMIN_SECRET)" required>
            <button id="fetch-registrations-btn" class="main-button" style="min-width: 100px;">Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        </div>
        
        <div id="admin-message-box" class="message-box secondary" style="display:none;"></div>
        <div id="loading-indicator">ğŸ”„ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

        <div id="table-container" style="overflow-x: auto;">
            <table id="registrations-list">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th>
                        <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                        <th>Ø§Ù„Ø§ØªØµØ§Ù„</th>
                        <th>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (ID)</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    </tr>
                </thead>
                <tbody id="registrations-body">
                    </tbody>
            </table>
        </div>
    </section>
</div>

<div id="action-menu" class="action-menu">
    <button data-status="accepted">Ù‚Ø¨ÙˆÙ„ (Accepted)</button>
    <button data-status="pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Pending)</button>
    <button data-status="rejected">Ø±ÙØ¶ (Rejected)</button>
</div>

<script>  
    const adminSecretInput = document.getElementById('admin-secret-input');
    const fetchButton = document.getElementById('fetch-registrations-btn');
    const registrationsBody = document.getElementById('registrations-body');
    const loadingIndicator = document.getElementById('loading-indicator');
    const adminMessageBox = document.getElementById('admin-message-box');
    const actionMenu = document.getElementById('action-menu');

    let currentTargetTag = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø¹Ù†ØµØ± Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡

    function showAdminMessage(message, isError = false) {
        adminMessageBox.className = isError ? 'message-box error' : 'message-box success';
        adminMessageBox.innerHTML = message;
        adminMessageBox.style.display = 'block';
    }

    function hideActionMenu() {
        actionMenu.style.display = 'none';
        currentTargetTag = null;
    }

    // 1. Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
    async function fetchRegistrations() {
        const adminSecret = adminSecretInput.value.trim();
        if (!adminSecret) {
            showAdminMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠ Ø£ÙˆÙ„Ø§Ù‹.', true);
            return;
        }

        loadingIndicator.style.display = 'block';
        registrationsBody.innerHTML = '';
        adminMessageBox.style.display = 'none';
        hideActionMenu();

        try {
            const response = await fetch('/api/admin/registrations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ adminSecret })
            });

            const data = await response.json();

            if (!response.ok) {
                showAdminMessage(data.message || 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', true);
                return;
            }

            renderRegistrations(data.registrations);
            showAdminMessage(`âœ… ØªÙ… Ø¬Ù„Ø¨ ${data.registrations.length} Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.`, false);

        } catch (error) {
            console.error('Fetch Admin Error:', error);
            showAdminMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ server.js.', true);
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    // 2. Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    function renderRegistrations(registrations) {
        registrationsBody.innerHTML = '';
        if (registrations.length === 0) {
            registrationsBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>';
            return;
        }

        registrations.forEach(reg => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${reg.name}</td>
                <td>${reg.level} / ${reg.year}</td>
                <td>${reg.subject}</td>
                <td>${reg.contact || 'N/A'}</td>
                <td dir="ltr" style="font-family: monospace; font-size: 0.8rem;">${reg.id}</td>
                <td><div class="status-tag status-${reg.status}" data-id="${reg.id}" data-current-status="${reg.status}">${getStatusText(reg.status)}</div></td>
            `;
            registrationsBody.appendChild(row);
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
        document.querySelectorAll('.status-tag').forEach(tag => {
            tag.addEventListener('click', showActionMenuForTag);
        });
    }

    function getStatusText(status) {
        switch(status) {
            case 'accepted': return 'Ù…Ù‚Ø¨ÙˆÙ„';
            case 'pending': return 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
            case 'rejected': return 'Ù…Ø±ÙÙˆØ¶';
            default: return 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        }
    }

    // 3. Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© (Context Menu)
    function showActionMenuForTag(event) {
        currentTargetTag = event.currentTarget;
        const rect = currentTargetTag.getBoundingClientRect();
        
        actionMenu.style.top = `${rect.bottom + 5}px`;
        actionMenu.style.left = `${rect.left}px`;
        actionMenu.style.display = 'block';
        event.stopPropagation();
    }

    // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…
    async function updateRegistrationStatus(newStatus) {
        if (!currentTargetTag) return;

        const registrationId = currentTargetTag.dataset.id;
        const adminSecret = adminSecretInput.value.trim();
        hideActionMenu();

        try {
            const response = await fetch('/api/admin/status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ adminSecret, registrationId, newStatus })
            });

            const data = await response.json();

            if (!response.ok) {
                showAdminMessage(data.message || 'ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©.', true);
                return;
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©
            currentTargetTag.className = `status-tag status-${newStatus}`;
            currentTargetTag.textContent = getStatusText(newStatus);
            currentTargetTag.dataset.currentStatus = newStatus;

            showAdminMessage(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ${registrationId} Ø¥Ù„Ù‰ ${getStatusText(newStatus)}.`);

        } catch (error) {
            console.error('Update Status Error:', error);
            showAdminMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«.', true);
        }
    }

    // 5. Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    fetchButton.addEventListener('click', fetchRegistrations);
    
    // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¨Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«
    actionMenu.querySelectorAll('button').forEach(button => {
        button.addEventListener('click', (event) => {
            updateRegistrationStatus(event.currentTarget.dataset.status);
        });
    });

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±
    document.addEventListener('click', (event) => {
        if (!actionMenu.contains(event.target) && !event.target.classList.contains('status-tag')) {
            hideActionMenu();
        }
    });

</script>  
</body>  
</html>
