<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no">
<title>أكاديمية المعالي | الإحصائيات</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* نفس المتغيرات والتصميم الأساسي لضمان التناسق */
:root{
  --bg: #0b0b0c;
  --drawer-bg: #151517;
  --text-primary: #ffffff;
  --text-secondary: #a1a1aa;
  --border-color: rgba(255,255,255,0.08);
  --accent-color: #3b82f6; 
  --success-color: #43cf66;
  --danger-color: #ff6347;
  --bottom-nav-height: 75px;
  --radius: 12px;
}

body{
  margin:0; font-family: "Tajawal", sans-serif;
  background-color: var(--bg); color: var(--text-primary);
  padding-bottom: var(--bottom-nav-height);
  direction: rtl;
}

/* Header */
.navbar{
  height: 72px; display: flex; align-items: center; justify-content: center;
  margin: 10px; border-radius: var(--radius);
  background: rgba(26, 26, 29, 0.85); backdrop-filter: blur(12px);
  border: 1px solid var(--border-color);
}
.navbar h1 { font-size: 18px; margin: 0; font-weight: 700; color: var(--accent-color); }

.container { padding: 15px; max-width: 1200px; margin: 0 auto; }

/* Dashboard Cards */
.stats-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;
}
.stat-box {
    background: var(--drawer-bg); border: 1px solid var(--border-color);
    padding: 15px; border-radius: var(--radius); text-align: center;
}
.stat-box .val { font-size: 24px; font-weight: 800; display: block; margin-bottom: 5px; }
.stat-box .lbl { font-size: 11px; color: var(--text-secondary); }

/* Charts */
.chart-container {
    background: var(--drawer-bg); border: 1px solid var(--border-color);
    padding: 15px; border-radius: var(--radius); margin-bottom: 20px;
}
.chart-title { font-size: 14px; font-weight: 700; margin-bottom: 15px; color: var(--text-secondary); border-right: 3px solid var(--accent-color); padding-right: 8px; }

/* Bottom Nav (نفس تصميم الهوم تماماً) */
.bottom-nav {
    position: fixed; bottom: 0; left: 0; width: 100%; height: var(--bottom-nav-height);
    background: rgba(21, 21, 23, 0.95); backdrop-filter: blur(15px);
    border-top: 1px solid var(--border-color); display: flex;
    justify-content: space-around; align-items: center; z-index: 2000;
}
.nav-item {
    background: none; border: none; display: flex; flex-direction: column;
    align-items: center; gap: 5px; color: var(--text-secondary);
    cursor: pointer; width: 60px; text-decoration: none;
}
.nav-item svg { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; }
.nav-item span { font-size: 11px; font-weight: 500; }
.nav-item.active { color: var(--accent-color); }

/* Loading Overlay */
#loader { text-align: center; padding: 50px; color: var(--text-secondary); }
</style>
</head>
<body>

<header class="navbar">
    <h1>الإحصائيات والتحليلات</h1>
</header>

<div class="container" id="mainContent" style="display:none;">
    <div class="stats-grid">
        <div class="stat-box">
            <span class="val" id="totalStudents">0</span>
            <span class="lbl">إجمالي الطلاب</span>
        </div>
        <div class="stat-box">
            <span class="val" id="collectionRate" style="color: var(--success-color);">0%</span>
            <span class="lbl">نسبة الدفع</span>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-title">نشاط الحصص (آخر 7 أيام)</div>
        <canvas id="activityChart"></canvas>
    </div>

    <div class="chart-container">
        <div class="chart-title">توزيع الطلاب حسب المرحلة</div>
        <div style="max-width: 250px; margin: 0 auto;">
            <canvas id="phaseChart"></canvas>
        </div>
    </div>
</div>

<div id="loader">جاري جلب البيانات...</div>

<nav class="bottom-nav">
    <a href="/" class="nav-item">
        <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
        <span>الرئيسية</span>
    </a>

    <div style="width: 60px;"></div>

    <div class="nav-item active">
        <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
        <span>البيانات</span>
    </div>
</nav>

<script>
    async function initDashboard() {
        try {
            const response = await fetch('/api/dashboard-stats');
            const data = await response.json();

            document.getElementById('totalStudents').textContent = data.totalStudents;
            const totalSess = data.totalPaidSessions + data.totalUnpaidSessions;
            const rate = totalSess > 0 ? Math.round((data.totalPaidSessions / totalSess) * 100) : 0;
            document.getElementById('collectionRate').textContent = rate + '%';

            // إعدادات الخطوط الافتراضية للرسوم
            Chart.defaults.color = '#a1a1aa';
            Chart.defaults.font.family = 'Tajawal';

            // 1. المنحنى البياني
            new Chart(document.getElementById('activityChart'), {
                type: 'line',
                data: {
                    labels: ['6 أيام', '5 أيام', '4 أيام', '3 أيام', 'أمس', 'اليوم'].reverse(),
                    datasets: [{
                        label: 'عدد الحصص',
                        data: data.activityLastWeek,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true, tension: 0.4, borderWidth: 3
                    }]
                },
                options: { plugins: { legend: { display: false } } }
            });

            // 2. الدائرة البيانية
            new Chart(document.getElementById('phaseChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.studentsByPhase),
                    datasets: [{
                        data: Object.values(data.studentsByPhase),
                        backgroundColor: ['#3b82f6', '#43cf66', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: { plugins: { legend: { position: 'bottom' } }, cutout: '70%' }
            });

            document.getElementById('loader').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        } catch (e) {
            document.getElementById('loader').textContent = 'فشل تحميل البيانات';
        }
    }
    initDashboard();
</script>
</body>
</html>
