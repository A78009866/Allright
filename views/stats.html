<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>أكاديمية المعالي | لوحة البيانات</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg: #0b0b0c;
  --card-bg: #151517;
  --text-primary: #ffffff;
  --text-secondary: #a1a1aa;
  --border-color: rgba(255,255,255,0.08);
  --accent-color: #3b82f6; 
  --danger-color: #ef4444;
  --success-color: #43cf66;
  --warning-color: #f59e0b;
  --purple-color: #8b5cf6;
  --radius: 12px;
}

*{box-sizing:border-box;}

body{
  margin:0;
  font-family: "Tajawal", sans-serif;
  background-color: var(--bg);
  color: var(--text-primary);
  background-image: radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.1) 0%, transparent 40%);
}

/* Navbar */
.navbar{
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(21, 21, 23, 0.8);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border-color);
  position: sticky; top: 0; z-index: 100;
}
.navbar h1 { margin: 0; font-size: 20px; font-weight: 700; }
.back-btn {
  text-decoration: none; color: var(--text-secondary);
  background: rgba(255,255,255,0.05); padding: 8px 15px;
  border-radius: 8px; font-size: 14px; transition: 0.2s;
}
.back-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }

/* Container */
.container {
    max-width: 1200px; margin: 0 auto; padding: 30px 20px;
}

/* Summary Cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}
.stat-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    padding: 20px; border-radius: var(--radius);
    display: flex; flex-direction: column; justify-content: center;
    position: relative; overflow: hidden;
}
.stat-card::after {
    content: ''; position: absolute; top: 0; right: 0; width: 4px; height: 100%;
    background: var(--accent-color);
}
.stat-card.success::after { background: var(--success-color); }
.stat-card.danger::after { background: var(--danger-color); }
.stat-card.purple::after { background: var(--purple-color); }

.stat-title { font-size: 14px; color: var(--text-secondary); margin-bottom: 5px; }
.stat-value { font-size: 32px; font-weight: 800; color: #fff; }
.stat-desc { font-size: 12px; color: var(--text-secondary); margin-top: 5px; }

/* Charts Section */
.charts-wrapper {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
}
.chart-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    padding: 20px; border-radius: var(--radius);
    min-height: 350px;
}
.chart-header { margin-bottom: 20px; font-size: 18px; font-weight: 600; color: #fff; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }

/* Loading */
#loading { text-align: center; margin-top: 50px; color: var(--text-secondary); }

@media (max-width: 768px) {
    .charts-wrapper { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<nav class="navbar">
    <a href="/" class="back-btn">العودة للرئيسية</a>
    <h1>إحصائيات الأكاديمية</h1>
</nav>

<div class="container">
    <div id="loading">جاري تحليل البيانات...</div>

    <div id="dashboardContent" style="display: none;">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title">إجمالي الطلاب المسجلين</div>
                <div class="stat-value" id="totalStudents">0</div>
                <div class="stat-desc">طالب نشط في النظام</div>
            </div>
            <div class="stat-card success">
                <div class="stat-title">الحصص المدفوعة</div>
                <div class="stat-value" id="paidSessions">0</div>
                <div class="stat-desc">إجمالي عمليات الدفع المسجلة</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-title">الحصص غير المدفوعة</div>
                <div class="stat-value" id="unpaidSessions">0</div>
                <div class="stat-desc">حصص مسجلة كدين على الطلاب</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-title">نسبة التحصيل</div>
                <div class="stat-value" id="collectionRate">0%</div>
                <div class="stat-desc">معدل الدفع مقابل التسجيل</div>
            </div>
        </div>

        <div class="charts-wrapper">
            <div class="chart-card">
                <div class="chart-header">النشاط الأسبوعي (الحصص والحضور)</div>
                <canvas id="activityChart"></canvas>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">توزيع الطلاب حسب المراحل</div>
                <div style="max-height: 300px; display: flex; justify-content: center;">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    Chart.defaults.color = '#a1a1aa';
    Chart.defaults.font.family = 'Tajawal';

    async function loadStats() {
        try {
            const res = await fetch('/api/dashboard-stats');
            if(!res.ok) throw new Error("Failed to fetch");
            const data = await res.json();

            // 1. Update Cards
            document.getElementById('totalStudents').textContent = data.totalStudents;
            document.getElementById('paidSessions').textContent = data.totalPaidSessions;
            document.getElementById('unpaidSessions').textContent = data.totalUnpaidSessions;
            
            const total = data.totalPaidSessions + data.totalUnpaidSessions;
            const rate = total > 0 ? Math.round((data.totalPaidSessions / total) * 100) : 0;
            document.getElementById('collectionRate').textContent = rate + '%';

            // 2. Render Line Chart (Activity)
            const ctxLine = document.getElementById('activityChart').getContext('2d');
            
            // Generate labels for last 7 days
            const labels = [];
            for(let i=6; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString('ar-EG', {weekday: 'short'}));
            }

            new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'عدد الأنشطة',
                        data: data.activityLastWeek,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // 3. Render Pie Chart (Distribution)
            const ctxPie = document.getElementById('distributionChart').getContext('2d');
            new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.studentsByPhase),
                    datasets: [{
                        data: Object.values(data.studentsByPhase),
                        backgroundColor: [
                            '#3b82f6', // أزرق
                            '#10b981', // أخضر
                            '#f59e0b'  // برتقالي
                        ],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 20 } }
                    }
                }
            });

            // Show Content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';

        } catch (e) {
            console.error(e);
            document.getElementById('loading').textContent = 'حدث خطأ في تحميل البيانات';
        }
    }

    loadStats();
</script>
</body>
</html>
